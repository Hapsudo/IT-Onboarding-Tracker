<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IT Onboarding Dashboard</title>
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <!-- jsPDF Library for PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-page">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h1>IT Onboarding Dashboard</h1>
          <p>Track and manage IT requests seamlessly</p>
        </div>
        <div class="login-form">
          <div class="form-group">
            <label for="loginRole">Select Your Role</label>
            <select id="loginRole" class="form-select">
              <option value="">-- Select Your Role --</option>
              <option value="IT Manager">IT Manager</option>
              <option value="HR">HR</option>
              <option value="Section Manager">Section Manager</option>
              <option value="Department GM">Department GM</option>
              <option value="HR Manager">HR Manager</option>
              <option value="GM HR">GM HR</option>
              <option value="DMD">DMD</option>
              <option value="MD">MD</option>
              <option value="Network Team">Network Team</option>
              <option value="Systems Team">Systems Team</option>
              <option value="Email Team">Email Team</option>
              <option value="Compliance Team">Compliance Team</option>
              <option value="Hardware Team">Hardware Team</option>
              <option value="Software Team">Software Team</option>
            </select>
          </div>
          <button onclick="handleLogin()" class="login-button">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard (Hidden initially) -->
  <div id="dashboard" class="dashboard-container hidden">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1>IT Onboarding Dashboard</h1>
        <div class="user-info">
          <span class="user-role-badge" id="userRoleBadge"></span>
          <button onclick="handleLogout()" class="logout-button">Logout</button>
        </div>
      </div>
    </header>

    <!-- Alert Container for Success/Error Messages -->
    <div id="alert" class="hidden fixed top-4 right-4 p-4 rounded shadow-lg text-white"></div>

    <div class="container">

      <!-- Navigation -->
      <nav class="nav-tabs" id="navTabs">
        <button class="nav-button active" data-section="personnel-request" data-role="HR,IT Manager">Personnel Request</button>
        <button class="nav-button" data-section="account-request" data-role="HR,IT Manager,Section Manager,Department GM,HR Manager,GM HR,DMD,MD,Network Team,Systems Team,Email Team,Compliance Team,Hardware Team,Software Team">Account Request</button>
        <button class="nav-button" data-section="approval" data-role="HR,IT Manager,Section Manager,Department GM,HR Manager,GM HR,DMD,MD,Network Team,Systems Team,Email Team,Compliance Team,Hardware Team,Software Team">Approvals</button>
        <button class="nav-button" data-section="it-manager" data-role="IT Manager">IT Manager</button>
        <button class="nav-button" data-section="task-dashboard" data-role="IT Manager,Network Team,Systems Team,Email Team,Compliance Team,Hardware Team,Software Team">Task Dashboard</button>
        <button class="nav-button" data-section="requests" data-role="HR,IT Manager,Section Manager,Department GM,HR Manager,GM HR,DMD,MD">Requests</button>
        <button class="nav-button" data-section="history" data-role="HR,IT Manager,Network Team,Systems Team,Email Team,Compliance Team,Hardware Team,Software Team">Request History</button>
      </nav>

    <!-- Personnel Request Section (HR7) -->
    <div id="personnel-request" class="section active">
      <h2>Submit Personnel Request (HR7)</h2>
      <form id="personnelRequestForm">
        <div class="flex">
          <div class="field-row">
            <label for="dateRequested">Date Requested:</label>
            <input id="dateRequested" name="dateRequested" type="date" readonly required />
          </div>
          <div class="field-row">
            <label for="recruitingManager">Recruiting Manager:</label>
            <input id="recruitingManager" name="recruitingManager" placeholder="Recruiting Manager" required />
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="position">Position:</label>
            <input id="position" name="position" placeholder="Position" required />
          </div>
          <div class="field-row">
            <label for="grade">Grade:</label>
            <input id="grade" name="grade" placeholder="Grade" required />
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">Type of Position:</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="positionType" value="Permanent" required /> Permanent</label>
            <label class="radio-label"><input type="radio" name="positionType" value="Contract" /> Contract</label>
            <label class="radio-label"><input type="radio" name="positionType" value="Intern" /> Intern</label>
          </div>
          <div class="field-row">
            <label for="duration">Duration:</label>
            <input id="duration" name="duration" placeholder="Duration (if Contract/Intern)" />
          </div>
        </div>
        <div class="form-group-compact">
          <h3 class="section-subtitle">Compensation Details</h3>
          <div class="flex">
            <div class="field-row">
              <label for="basicPay">Basic Pay:</label>
              <input id="basicPay" name="basicPay" type="number" required />
            </div>
            <div class="field-row">
              <label for="houseAllowance">House Allowance:</label>
              <input id="houseAllowance" name="houseAllowance" type="number" required />
            </div>
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">Resource Planning:</label>
          <div class="checkbox-group-compact">
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Desk" /> Desk</label>
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Laptop" /> Laptop</label>
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Desk-to-Computer" /> Desk-to-Computer</label>
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Email Address" /> Email Address</label>
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Airtime" /> Airtime</label>
            <label class="checkbox-label"><input type="checkbox" name="resources" value="Telephone Extension" /> Telephone Extension</label>
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="budgeted">Budgeted?:</label>
            <select id="budgeted" name="budgeted" required>
              <option value="">Budgeted?</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="field-row">
            <label for="costCentre">Cost Centre:</label>
            <input id="costCentre" name="costCentre" placeholder="Cost Centre" required />
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">Recruitment Source:</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="recruitmentSource" value="Internal" required /> Internal</label>
            <label class="radio-label"><input type="radio" name="recruitmentSource" value="External" /> External</label>
          </div>
        </div>
        <div class="field-row">
          <label for="reportDate">Date Employee Should Report:</label>
          <input id="reportDate" name="reportDate" type="date" required onchange="checkLeadTime('personnel')" />
          <div id="personnelLeadTimeWarning" class="lead-time-warning hidden"></div>
          <div id="personnelLeadTimeStatus" class="lead-time-status"></div>
        </div>
        <div class="field-row">
          <label for="reasonsForRecruiting">Reasons for Recruiting:</label>
          <textarea id="reasonsForRecruiting" name="reasonsForRecruiting" placeholder="Explain the reasons for this recruitment..." rows="4" required></textarea>
        </div>
        <div>
          <label>Job Profile (Signed Document):</label>
          <input type="file" name="jobProfile" accept=".pdf,.jpg,.png" />
        </div>
        <input type="submit" value="Submit Personnel Request" />
      </form>
    </div>

    <!-- Combined Account Request Section (Corp6 + Corp5) -->
    <div id="account-request" class="section">
      <h2>Submit Account Request (Staff & SAP/TALO)</h2>
      <form id="accountRequestForm">
        <!-- Date Field at Top -->
        <div class="field-row">
          <label for="accountRequestDate">Date:</label>
          <input id="accountRequestDate" name="accountRequestDate" type="date" readonly required />
        </div>
        <!-- Requester Information -->
        <h3>Requester Information</h3>
        <div class="flex">
          <div class="field-row">
            <label for="companyName">Company Name:</label>
            <input id="companyName" name="companyName" placeholder="Company Name" required />
          </div>
          <div class="field-row">
            <label for="requesterName">Requester Name:</label>
            <input id="requesterName" name="requesterName" placeholder="Requester Name" required />
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="requesterPosition">Requester Position:</label>
            <input id="requesterPosition" name="requesterPosition" placeholder="Requester Position" required />
          </div>
          <div class="field-row">
            <label for="requesterTelephoneExt">Requester's Telephone Ext:</label>
            <input id="requesterTelephoneExt" name="requesterTelephoneExt" placeholder="Requester's Telephone Ext" required />
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="department">Department:</label>
            <input id="department" name="department" placeholder="Department" required />
          </div>
          <div class="field-row">
            <label for="division">Division:</label>
            <input id="division" name="division" placeholder="Division" required />
          </div>
        </div>
        <!-- Details of Joining User/Employee -->
        <h3>Details of Joining User/Employee</h3>
        <div class="flex">
          <div class="field-row">
            <label for="firstName">First Name:</label>
            <input id="firstName" name="firstName" placeholder="First Name" required />
          </div>
          <div class="field-row">
            <label for="lastName">Last Name:</label>
            <input id="lastName" name="lastName" placeholder="Last Name" required />
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="jobTitle">Job Title:</label>
            <input id="jobTitle" name="jobTitle" placeholder="Job Title" required />
          </div>
          <div class="field-row">
            <label for="employeeStatus">Employee Status:</label>
            <select id="employeeStatus" name="employeeStatus" required>
              <option value="">Select Employee Status</option>
              <option value="Permanent">Permanent</option>
              <option value="Contract">Contract</option>
              <option value="Temporary">Temporary</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <label for="accountReportDate">Date to Report:</label>
          <input id="accountReportDate" name="accountReportDate" type="date" required onchange="checkAccountLeadTime()" />
          <div id="accountReportLeadTimeWarning" class="lead-time-warning hidden"></div>
          <div id="accountReportLeadTimeStatus" class="lead-time-status"></div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">ICT Requests:</label>
          <div class="checkbox-group-compact">
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="Laptop" /> Laptop</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="Desk-to-Computer" /> Desk To Computer</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="Email Address" /> Email Address</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="Airtime" /> Airtime</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="Telephone Extension" /> Telephone Extension</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="VPN" /> VPN</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="KAIZEN SYSTEM" /> Kaizen System</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="WINDOWS ACCOUNT" /> Windows Account</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="VEHICLE SYSTEM" /> Vehicle System</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="SMS" /> SMS</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="INTERNET" /> Internet</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="INTRANET" /> Intranet</label>
            <label class="checkbox-label"><input type="checkbox" name="ictRequests" value="LEAVE SYSTEM" /> Leave System</label>
          </div>
        </div>
        <div class="field-row">
          <label for="physicalLocation">Physical Location:</label>
          <select id="physicalLocation" name="physicalLocation" required>
            <option value="">Select Location</option>
            <option value="HQ">HQ</option>
            <option value="Business Park">Business Park</option>
            <option value="Westland">Westland</option>
            <option value="Kampala Rd">Kampala Rd</option>
            <option value="Kirinyaga Rd">Kirinyaga Rd</option>
            <option value="Mombasa">Mombasa</option>
            <option value="Eldoret">Eldoret</option>
            <option value="Kisumu">Kisumu</option>
            <option value="Lodwar">Lodwar</option>
            <option value="LOXEA">LOXEA</option>
            <option value="TYDIA">TYDIA</option>
            <option value="DOBIE">DOBIE</option>
            <option value="Ngong Rd">Ngong Rd</option>
            <option value="Nyeri">Nyeri</option>
            <option value="Nanyuki">Nanyuki</option>
            <option value="CFAO KE">CFAO KE</option>
            <option value="CFAO AGRI">CFAO AGRI</option>
            <option value="WINPART">WINPART</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <!-- Additional Access and Account Management -->
        <div>
          <h3>Provide Access to the following:</h3>
          <div class="field-row">
            <label>Intranet Sites/Libraries:</label>
            <input name="intranetSites" placeholder="Intranet Sites/Libraries" />
          </div>
          <div class="field-row">
            <label>Shared Folders:</label>
            <input name="sharedFolders" placeholder="Shared Folders" />
          </div>
          <div class="field-row">
            <label>All requested above Account Expiry Date:</label>
            <input name="accountExpiryDate" id="accountExpiryDate" type="date" />
          </div>
          <div class="field-row">
            <label>Others:</label>
            <input name="othersAccess" placeholder="Others" />
          </div>
          <div class="flex">
            <div class="field-row">
              <label>Account setup by:</label>
              <input name="accountSetupBy" placeholder="Account setup by" />
            </div>
          </div>
        </div>
        <!-- SAP/TALO Authorization Details (Corp5) -->
        <h3>SAP/TALO Authorization Details</h3>
        <div class="flex">
          <div class="field-row">
            <label for="userDepartment">User Department:</label>
            <input id="userDepartment" name="userDepartment" placeholder="User Department" required />
          </div>
          <div class="field-row">
            <label for="proposedUserPosition">Proposed User Position:</label>
            <input id="proposedUserPosition" name="proposedUserPosition" placeholder="Proposed User Position" required />
          </div>
        </div>
        <div class="flex">
          <div class="field-row">
            <label for="pfNumber">PF Number:</label>
            <input id="pfNumber" name="pfNumber" placeholder="PF Number" required />
          </div>
          <div class="field-row">
            <label for="userDivision">User Division:</label>
            <input id="userDivision" name="userDivision" placeholder="User Division" required />
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">Proposed User:</label>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="userType" value="New" required /> New</label>
            <label class="radio-label"><input type="radio" name="userType" value="Existing" /> Existing</label>
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label">Systems Requested:</label>
          <div class="checkbox-group-compact">
            <label class="checkbox-label"><input type="checkbox" name="systems" value="SAP" /> SAP</label>
            <label class="checkbox-label"><input type="checkbox" name="systems" value="TALO" /> TALO</label>
            <label class="checkbox-label"><input type="checkbox" name="systems" value="Synertrade" /> Synertrade</label>
            <label class="checkbox-label"><input type="checkbox" name="systems" value="FleetWave" /> FleetWave</label>
            <label class="checkbox-label"><input type="checkbox" name="systems" value="Syspro" /> Syspro</label>
          </div>
        </div>
        <div class="form-group-compact">
          <div class="field-row">
            <label for="outsourced">Outsourced Staff:</label>
            <label class="checkbox-label" style="margin: 0;"><input type="checkbox" id="outsourced" name="outsourced" value="Yes" /> Yes</label>
          </div>
          <div class="field-row">
            <label for="entityName">Entity Name:</label>
            <input id="entityName" name="entityName" placeholder="Entity Name (if Outsourced)" />
          </div>
        </div>
        <div id="systemFields"></div>
        <div>
          <label>Validity:</label>
          <div>
            <label><input type="radio" name="validity" value="Permanent" required /> Permanent</label>
            <label><input type="radio" name="validity" value="Short Period" /> Short Period</label>
            <div class="field-row">
              <label for="validityDuration">Duration:</label>
              <input id="validityDuration" name="validityDuration" placeholder="Duration (if Short Period)" />
            </div>
          </div>
        </div>
        <!-- Document Fields -->
        <div class="form-group-compact">
          <h3 class="section-subtitle">Required Documents</h3>
          <div class="field-row">
            <label>Signed user email account Document:</label>
            <input type="file" name="signedDocument" accept=".pdf,.jpg,.png" />
          </div>
          <div class="field-row">
            <label>Signed SAP ACCOUNT Document:</label>
            <input type="file" name="signedSAPDocument" accept=".pdf,.jpg,.png" />
          </div>
        </div>
        <input type="submit" value="Submit Account Request" />
      </form>
    </div>

    <!-- Approvals Section -->
    <div id="approval" class="section">
      <h2>Approvals</h2>
      <div class="filter-section">
        <label>Filter by Status:</label>
        <select id="approvalFilter" onchange="filterApprovals()">
          <option value="all">All Pending Approvals</option>
          <option value="awaiting">Awaiting Approval</option>
          <option value="approved">Fully Approved</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Employee Name</th>
            <th>Department</th>
            <th>Date Submitted</th>
            <th>Date Joining</th>
            <th>Days to Onboarding</th>
            <th>Lead Time Status</th>
            <th>Details</th>
            <th>Status</th>
            <th>Next Approver</th>
            <th>Signed File</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="approvalTableBody"></tbody>
      </table>
    </div>

    <!-- IT Manager Assignment Section -->
    <div id="it-manager" class="section">
      <h2>IT Manager - Task Assignment</h2>
      <div id="itManagerRequests">
        <p>No requests pending IT Manager assignment.</p>
      </div>
    </div>

    <!-- Task Dashboard Section -->
    <div id="task-dashboard" class="section">
      <h2>IT Team Task Dashboard</h2>
      <div class="team-filter">
        <label>Your Team:</label>
        <span id="currentTeamDisplay" class="team-badge"></span>
      </div>
       <div class="team-filter">
+        <label>Your Team:</label>
+        <select id="teamSelect">
+          <option value="">-- Select IT Team --</option>
      <div id="taskDashboardContent">
        <p>No tasks assigned to your team.</p>
      </div>
    </div>

    <!-- Requests Tab - New Section -->
    <div id="requests" class="section">
      <h2>ðŸ“‹ All Requests - Download & Print</h2>
      <div class="filter-section">
        <label>Filter by Type:</label>
        <select id="requestsFilter" onchange="filterRequests()">
          <option value="all">All Requests</option>
          <option value="personnel">Personnel Requests (HR7)</option>
          <option value="account">Account Requests (Corp6 + Corp5)</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Request ID</th>
            <th>Type</th>
            <th>Employee Name</th>
            <th>Department</th>
            <th>Date Submitted</th>
            <th>Date Joining</th>
            <th>Status</th>
            <th>Download Forms</th>
          </tr>
        </thead>
        <tbody id="requestsTableBody"></tbody>
      </table>
    </div>

    <!-- Request History Section -->
    <div id="history" class="section">
      <h2>Request History</h2>
      <div class="filter-section">
        <label>Filter by Status:</label>
        <select id="historyFilter" onchange="filterHistory()">
          <option value="all">All Requests</option>
          <option value="pending">Pending</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Employee Name</th>
            <th>Department</th>
            <th>Date Submitted</th>
            <th>Date Joining</th>
            <th>Days to Onboarding</th>
            <th>Lead Time Status</th>
            <th>Details</th>
            <th>Status</th>
            <th>IT Sections</th>
            <th>Approval Dates</th>
            <th>Signed File</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="historyTableBody"></tbody>
      </table>
    </div>
    </div>
  </div>
  <!-- End Dashboard -->

  <script>
    // Initialize EmailJS with your User ID
    (function() {
      emailjs.init('czjSvxD8sC2qlZwyB');
    })();

    // Global functions
    function setRole() {
      handleLogin();
    }

    // Lead time validation (14 days minimum)
    function checkLeadTime(formType) {
      if (formType === 'personnel') {
        const reportDateInput = document.getElementById('reportDate');
        const warningDiv = document.getElementById('personnelLeadTimeWarning');
        const statusDiv = document.getElementById('personnelLeadTimeStatus');

        if (!reportDateInput || !reportDateInput.value) return;

        const joiningDate = new Date(reportDateInput.value);
        const today = new Date();
        const daysDiff = Math.ceil((joiningDate - today) / (1000 * 60 * 60 * 24));

        if (daysDiff < 14) {
          warningDiv.textContent = `âš ï¸ Warning: Only ${daysDiff} days until joining date. Minimum 14 days required.`;
          warningDiv.classList.remove('hidden');
          warningDiv.classList.add('warning-red');
          statusDiv.textContent = `Lead Time: ${daysDiff} days (Insufficient)`;
          statusDiv.className = 'lead-time-status status-red';
        } else {
          warningDiv.classList.add('hidden');
          statusDiv.textContent = `Lead Time: ${daysDiff} days (âœ“ Sufficient)`;
          statusDiv.className = 'lead-time-status status-green';
        }
      }
    }

    // Account Request Lead Time validation
    function checkAccountLeadTime() {
      const accountDateInput = document.getElementById('accountRequestDate');
      const reportDateInput = document.getElementById('accountReportDate');
      const warningDiv = document.getElementById('accountReportLeadTimeWarning');
      const statusDiv = document.getElementById('accountReportLeadTimeStatus');

      if (!accountDateInput || !accountDateInput.value || !reportDateInput || !reportDateInput.value) {
        return;
      }

      const requestDate = new Date(accountDateInput.value);
      const reportDate = new Date(reportDateInput.value);
      const daysDiff = Math.ceil((reportDate - requestDate) / (1000 * 60 * 60 * 24));

      if (daysDiff < 14) {
        warningDiv.textContent = `âš ï¸ Warning: Only ${daysDiff} days between request date and report date. Minimum 14 days required.`;
        warningDiv.classList.remove('hidden');
        warningDiv.classList.add('warning-red');
        statusDiv.textContent = `Lead Time: ${daysDiff} days (Insufficient)`;
        statusDiv.className = 'lead-time-status status-red';
      } else {
        warningDiv.classList.add('hidden');
        statusDiv.textContent = `Lead Time: ${daysDiff} days (âœ“ Sufficient)`;
        statusDiv.className = 'lead-time-status status-green';
      }
    }

    function resetFormWarnings() {
      const personnelWarning = document.getElementById('personnelLeadTimeWarning');
      const personnelStatus = document.getElementById('personnelLeadTimeStatus');
      if (personnelWarning) {
        personnelWarning.classList.add('hidden');
        personnelWarning.textContent = '';
        personnelWarning.classList.remove('warning-red');
      }
      if (personnelStatus) {
        personnelStatus.textContent = '';
        personnelStatus.className = 'lead-time-status';
      }

      const accountWarning = document.getElementById('accountReportLeadTimeWarning');
      const accountStatus = document.getElementById('accountReportLeadTimeStatus');
      if (accountWarning) {
        accountWarning.classList.add('hidden');
        accountWarning.textContent = '';
        accountWarning.classList.remove('warning-red');
      }
      if (accountStatus) {
        accountStatus.textContent = '';
        accountStatus.className = 'lead-time-status';
      }
    }

    function calculateDaysToOnboarding(joiningDate, submissionDate) {
      if (!joiningDate) return 'N/A';
      const join = new Date(joiningDate);
      const submit = submissionDate ? new Date(submissionDate) : new Date();
      const days = Math.ceil((join - submit) / (1000 * 60 * 60 * 24));
      return days;
    }

    function getLeadTimeStatus(days) {
      if (days === 'N/A') return { text: 'N/A', class: '' };
      if (days >= 14) return { text: 'âœ“ Sufficient', class: 'status-green' };
      return { text: 'âš  Insufficient', class: 'status-red' };
    }

    // Helper function to get local date in YYYY-MM-DD format
    function getLocalDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alert');
      if (!alertBox) return;
      console.log(`Alert: ${message} (${type})`);
      alertBox.textContent = message;
      alertBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
      alertBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
      setTimeout(() => {
        alertBox.classList.add('hidden');
      }, 5000);
    }

    // Global variables
    let requests = [];
    let personnelApprovers = [];
    let accountApprovers = [];
    let itTeams = {};
    let currentUserRole = '';

    document.addEventListener('DOMContentLoaded', function () {
      const sections = document.querySelectorAll('.section');
      const buttons = document.querySelectorAll('.nav-button');
      const approvalTableBody = document.getElementById('approvalTableBody');
      const historyTableBody = document.getElementById('historyTableBody');
      const systemFields = document.getElementById('systemFields');
      const personnelForm = document.getElementById('personnelRequestForm');
      const accountForm = document.getElementById('accountRequestForm');

      // Set Date Requested to today's date automatically
      const dateRequestedField = document.getElementById('dateRequested');
      if (dateRequestedField) {
        const today = getLocalDateString();
        dateRequestedField.value = today;
        dateRequestedField.setAttribute('readonly', 'readonly');
      }

      // Set Account Request Date to today's date automatically
      const accountRequestDateField = document.getElementById('accountRequestDate');
      if (accountRequestDateField) {
        const today = getLocalDateString();
        accountRequestDateField.value = today;
        accountRequestDateField.setAttribute('readonly', 'readonly');
      }

      // Approval workflow configuration
      personnelApprovers = [
        { role: 'Section Manager', email: 'section.manager@cfao.com' },
        { role: 'Department GM', email: 'dept.gm@cfao.com' },
        { role: 'HR Manager', email: 'hr.manager@cfao.com' },
        { role: 'GM HR', email: 'gm.hr@cfao.com' },
        { role: 'DMD', email: 'dmd@cfao.com' },
        { role: 'MD', email: 'md@cfao.com' }
      ];
      accountApprovers = [
        { role: 'Section Manager', email: 'section.manager@cfao.com' },
        { role: 'Department GM', email: 'dept.gm@cfao.com' },
        { role: 'HR Manager', email: 'hr.manager@cfao.com' },
        { role: 'GM HR', email: 'gm.hr@cfao.com' },
        { role: 'DMD', email: 'dmd@cfao.com' },
        { role: 'MD', email: 'md@cfao.com' }
      ];

      // IT Teams mapping
      itTeams = {
        'Hardware Team': { email: 'hardware@cfao.com', lead: 'Hardware Team Lead' },
        'Software Team': { email: 'software@cfao.com', lead: 'Software Team Lead' },
        'Network Team': { email: 'network@cfao.com', lead: 'Network Team Lead' },
        'Systems Team': { email: 'systems@cfao.com', lead: 'Systems Team Lead' },
        'Email Team': { email: 'email@cfao.com', lead: 'Email Team Lead' },
        'Compliance Team': { email: 'compliance@cfao.com', lead: 'Compliance Team Lead' }
      };

      function sendEmail(to, subject, message) {
        try {
          emailjs.send('service_ejzo9cn', 'template_gruv4yp', {
            to_email: to,
            subject: subject,
            message: message
          }).then(
            () => {
              console.log(`Email sent to ${to}: ${subject}`);
              showAlert(`Notification sent to ${to}.`, 'success');
            },
            (error) => {
              console.error('Email sending failed:', error);
              showAlert('Failed to send email notification.', 'error');
            }
          );
        } catch (e) {
          console.log('Email service unavailable, skipping notification:', e);
        }
      }

      // Dynamically add system fields
      const systemCheckboxes = document.querySelectorAll('input[name="systems"]');
      systemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          systemFields.innerHTML = '';
          const selectedSystems = Array.from(systemCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
          selectedSystems.forEach(system => {
            systemFields.innerHTML += `
              <div class="system-field">
                <h4>${system}</h4>
                <select name="roles_${system}" required>
                  <option value="">Select Role</option>
                  <option value="Admin">Admin</option>
                  <option value="User">User</option>
                  <option value="Viewer">Viewer</option>
                  <option value="Custom">Custom</option>
                </select>
                <input name="customRole_${system}" placeholder="Custom Role (if selected)" style="display: none;" />
                <textarea name="reasons_${system}" placeholder="Exact ${system} roles requested and plants and companies to access" required></textarea>
              </div>`;
          });
          document.querySelectorAll('select[name^="roles_"]').forEach(select => {
            select.addEventListener('change', () => {
              const system = select.name.replace('roles_', '');
              const customInput = document.querySelector(`input[name="customRole_${system}"]`);
              customInput.style.display = select.value === 'Custom' ? 'block' : 'none';
              if (select.value !== 'Custom') customInput.value = '';
            });
          });
        });
      });
      function renderApproval() {
        approvalTableBody.innerHTML = '';
        const filterValue = document.getElementById('approvalFilter')?.value || 'all';
        let filteredRequests = requests.filter(r => r.status.includes('Awaiting') || r.status === 'Pending IT Manager');
        
        if (filterValue === 'awaiting') {
          filteredRequests = filteredRequests.filter(r => r.status.includes('Awaiting'));
        } else if (filterValue === 'approved') {
          filteredRequests = filteredRequests.filter(r => r.status === 'Pending IT Manager');
        }

        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || r.accountExpiryDate || 'N/A');
          const daysToOnboarding = calculateDaysToOnboarding(joiningDate, r.submissionDate || r.accountRequestDate);
          const leadTimeStatus = getLeadTimeStatus(daysToOnboarding);
          const details = r.type === 'personnel'
            ? `Position: ${r.position}, Resources: ${r.resources ? r.resources.join(', ') : 'None'}`
            : `Systems: ${r.systems ? r.systems.join(', ') : 'None'}`;
          const approvers = r.type === 'personnel' ? personnelApprovers : accountApprovers;
          const currentApprover = approvers.find(a => r.status === `Awaiting ${a.role}`);
          
          approvalTableBody.innerHTML += `
            <tr>
              <td>${r.type}</td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td>${daysToOnboarding} days</td>
              <td class="${leadTimeStatus.class}">${leadTimeStatus.text}</td>
              <td>${details}</td>
              <td>${r.status}</td>
              <td>${currentApprover ? currentApprover.role : (r.status === 'Pending IT Manager' ? 'IT Manager' : 'None')}</td>
              <td>${r.type === 'account' 
                ? (r.signedFile ? `<a href="${r.signedFile}" download>Email Doc</a>` : 'No Email Doc') + 
                  (r.signedSAPFile ? ` | <a href="${r.signedSAPFile}" download>SAP Doc</a>` : ' | No SAP Doc')
                : (r.signedFile ? `<a href="${r.signedFile}" download>Download</a>` : 'None')}</td>
              <td>
                <button onclick="approveRequest('${r.id}', '${r.type}')">Approve</button>
                <button onclick="rejectRequest('${r.id}', '${r.type}')">Reject</button>
              </td>
            </tr>`;
        });
      }

      window.filterApprovals = function() {
        renderApproval();
      }

      function renderHistory() {
        historyTableBody.innerHTML = '';
        const filterValue = document.getElementById('historyFilter')?.value || 'all';
        let filteredRequests = requests.filter(r => !r.status.includes('Awaiting') && r.status !== 'Pending IT Manager');
        
        if (filterValue === 'pending') {
          filteredRequests = filteredRequests.filter(r => r.status === 'Pending');
        } else if (filterValue === 'in-progress') {
          filteredRequests = filteredRequests.filter(r => r.status === 'In Progress');
        } else if (filterValue === 'completed') {
          filteredRequests = filteredRequests.filter(r => r.status === 'Completed');
        } else if (filterValue === 'rejected') {
          filteredRequests = filteredRequests.filter(r => r.status === 'Rejected');
        }

        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || r.accountExpiryDate || 'N/A');
          const daysToOnboarding = calculateDaysToOnboarding(joiningDate, r.submissionDate || r.accountRequestDate);
          const leadTimeStatus = getLeadTimeStatus(daysToOnboarding);
          const details = r.type === 'personnel'
            ? `Position: ${r.position}, Resources: ${r.resources ? r.resources.join(', ') : 'None'}`
            : `Systems: ${r.systems ? r.systems.join(', ') : 'None'}`;
          const itSections = r.assignedTeams ? r.assignedTeams.map(t => {
            const taskStatus = r.itTasks && r.itTasks[t] ? r.itTasks[t].status : 'Not Started';
            return `${t}: ${taskStatus}`;
          }).join('; ') : 'Not Assigned';
          const approvalDates = r.approvalDates ? Object.entries(r.approvalDates)
            .map(([role, date]) => `${role}: ${date}`).join('; ') : 'N/A';
          
          historyTableBody.innerHTML += `
            <tr>
              <td>${r.type}</td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td>${daysToOnboarding} days</td>
              <td class="${leadTimeStatus.class}">${leadTimeStatus.text}</td>
              <td>${details}</td>
              <td>${r.status}</td>
              <td>${itSections}</td>
              <td>${approvalDates}</td>
              <td>${r.type === 'account' 
                ? (r.signedFile ? `<a href="${r.signedFile}" download>Email Doc</a>` : 'No Email Doc') + 
                  (r.signedSAPFile ? ` | <a href="${r.signedSAPFile}" download>SAP Doc</a>` : ' | No SAP Doc')
                : (r.signedFile ? `<a href="${r.signedFile}" download>Download</a>` : 'None')}</td>
              <td>
                ${r.status === 'Pending' ? `<button onclick="markInProgress('${r.id}')">In Progress</button>` : ''}
                ${r.status === 'In Progress' ? `<button onclick="markComplete('${r.id}', '${r.type}')">Complete</button>` : ''}
              </td>
            </tr>`;
        });
      }

      window.filterHistory = function() {
        renderHistory();
      }

      function renderITManager() {
        const itManagerDiv = document.getElementById('itManagerRequests');
        const pendingRequests = requests.filter(r => r.status === 'Pending IT Manager');
        
        if (pendingRequests.length === 0) {
          itManagerDiv.innerHTML = '<p>No requests pending IT Manager assignment.</p>';
          return;
        }

        let html = '<div class="it-manager-requests">';
        pendingRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const ictRequests = r.ictRequests || r.resources || [];
          
          html += `
            <div class="it-request-card">
              <h3>Request ${r.id} - ${employeeName}</h3>
              <p><strong>Type:</strong> ${r.type}</p>
              <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
              <p><strong>ICT Requirements:</strong> ${ictRequests.join(', ') || 'None'}</p>
              <div class="team-assignment">
                <label>Assign to IT Teams:</label>
                ${Object.keys(itTeams).map(team => `
                  <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                    <label style="margin:0;">
                      <input type="checkbox" name="assign_${r.id}" value="${team}" 
                        ${r.assignedTeams && r.assignedTeams.includes(team) ? 'checked' : ''}>
                      ${team}
                    </label>
                    <input type="text" name="assign_${r.id}_assignee_${team}" placeholder="Assignee name (optional)"
                      value="${r.itTasks && r.itTasks[team] ? (r.itTasks[team].assignee || '') : ''}" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
                  </div>
                `).join('')}
              </div>
              <button onclick="assignToITTeams('${r.id}')">Assign and Notify Teams</button>
            </div>
          `;
        });
        html += '</div>';
        itManagerDiv.innerHTML = html;
      }

      window.assignToITTeams = function (requestId) {
        const req = requests.find(r => r.id === requestId);
        if (!req) {
          showAlert('Request not found.', 'error');
          return;
        }

        const checkboxes = document.querySelectorAll(`input[name="assign_${requestId}"]:checked`);
        const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

        if (selectedTeams.length === 0) {
          showAlert('Please select at least one IT team.', 'error');
          return;
        }

        req.assignedTeams = selectedTeams;
        req.status = 'In Progress';
        if (!req.itTasks) req.itTasks = {};

        selectedTeams.forEach(team => {
          if (!req.itTasks[team]) {
            req.itTasks[team] = { status: 'Not Started', notes: '', assignee: '' };
          }
          const assigneeInput = document.querySelector(`[name="assign_${requestId}_assignee_${team}"]`);
          if (assigneeInput) {
            req.itTasks[team].assignee = assigneeInput.value.trim();
          }
        });

        selectedTeams.forEach(team => {
          const teamInfo = itTeams[team];
          if (teamInfo) {
            sendEmail(
              teamInfo.email,
              'New IT Task Assigned',
              `A new IT task has been assigned to ${team}. Request ID: ${requestId}, Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Assigned to: ${req.itTasks[team].assignee || 'Unassigned'}. Please review and update status.`
            ).catch(() => console.log(`Email failed for ${team}, proceeding without notification`));
          }
        });

        showAlert(`Request ${requestId} assigned to ${selectedTeams.length} IT team(s).`, 'success');
        renderITManager();
        renderHistory();
        renderTaskDashboard();
        renderRequests();
      };

      function renderTaskDashboard() {
        const taskDashboard = document.getElementById('taskDashboardContent');
        const currentRole = currentUserRole || document.getElementById('userRoleBadge')?.textContent.trim();
        
        if (!currentRole) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const teamName = Object.keys(itTeams).find(team => 
          currentRole === team || currentRole.includes(team)
        );
        
        if (!teamName) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const assignedRequests = requests.filter(r => 
          r.assignedTeams && r.assignedTeams.includes(teamName) && 
          (r.status === 'In Progress' || r.status === 'Completed' || r.status === 'Pending')
        );

        if (assignedRequests.length === 0) {
          taskDashboard.innerHTML = `<p>No tasks assigned to ${teamName}.</p>`;
          return;
        }

        let html = '<div class="task-list">';
        assignedRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const taskStatus = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].status : 'Not Started';
          const taskNotes = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].notes : '';
          const assignee = r.itTasks && r.itTasks[teamName] ? (r.itTasks[teamName].assignee || 'Unassigned') : 'Unassigned';
          
          html += `
            <div class="task-card">
              <h4>Request ${r.id} - ${employeeName}</h4>
              <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
              <p><strong>Request Date:</strong> ${r.submissionDate || r.date}</p>
              <p><strong>Assignee:</strong> ${assignee}</p>
              <p><strong>Current Status:</strong> ${taskStatus}</p>
              <div class="task-actions">
                <select id="taskStatus_${r.id}_${teamName}" onchange="updateTaskStatus('${r.id}', '${teamName}')">
                  <option value="Not Started" ${taskStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  <option value="In Progress" ${taskStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Completed" ${taskStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
                <textarea id="taskNotes_${r.id}_${teamName}" placeholder="Add completion notes..." rows="3">${taskNotes}</textarea>
                <button onclick="saveTaskNotes('${r.id}', '${teamName}')">Save Notes</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        taskDashboard.innerHTML = html;
      }

      // REQUESTS TAB RENDERING
      function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const filterValue = document.getElementById('requestsFilter')?.value || 'all';
        
        let filteredRequests = requests;
        if (filterValue === 'personnel') {
          filteredRequests = requests.filter(r => r.type === 'personnel');
        } else if (filterValue === 'account') {
          filteredRequests = requests.filter(r => r.type === 'account');
        }

        if (filteredRequests.length === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No requests found.</td></tr>';
          return;
        }

        requestsTableBody.innerHTML = '';
        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || 'N/A');
          
          const downloadButtons = r.type === 'personnel' 
            ? `<button onclick="downloadHR7PDF('${r.id}')" class="download-btn">ðŸ“„ Download HR7</button>`
            : `<button onclick="downloadCorp6PDF('${r.id}')" class="download-btn">ðŸ“„ Download Corp6</button><br/>
               ${r.systems && r.systems.length > 0 ? r.systems.map(sys => 
                 `<button onclick="downloadCorp5PDF('${r.id}', '${sys}')" class="download-btn-small">ðŸ“‹ ${sys} Form</button>`
               ).join(' ') : ''}`;
          
          requestsTableBody.innerHTML += `
            <tr>
              <td><strong>${r.id}</strong></td>
              <td><span class="type-badge type-${r.type}">${r.type.toUpperCase()}</span></td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td><span class="status-badge status-${r.status.toLowerCase().replace(/\s+/g, '-')}">${r.status}</span></td>
              <td>${downloadButtons}</td>
            </tr>`;
        });
      }

      window.filterRequests = function() {
        renderRequests();
      };

      // Handle Personnel Request Form Submission
      personnelForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Personnel Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['dateRequested', 'recruitingManager', 'position', 'grade', 'basicPay', 'houseAllowance', 'budgeted', 'costCentre', 'reportDate', 'reasonsForRecruiting'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('positionType')) {
          isValid = false;
          missingFields.push('positionType');
        }
        if (!formData.get('recruitmentSource')) {
          isValid = false;
          missingFields.push('recruitmentSource');
        }
        if ((formData.get('positionType') === 'Contract' || formData.get('positionType') === 'Intern') && !formData.get('duration')) {
          isValid = false;
          missingFields.push('duration');
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const reportDate = formData.get('reportDate');
        const submissionDate = getLocalDateString();
        const daysDiff = Math.ceil((new Date(reportDate) - new Date(submissionDate)) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 14) {
          if (!confirm(`Warning: Only ${daysDiff} days until joining date. Minimum 14 days required. Do you want to proceed anyway?`)) {
            return;
          }
        }

        const file = formData.get('jobProfile');
        const submitRequest = (signedFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'personnel',
            dateRequested: formData.get('dateRequested'),
            recruitingManager: formData.get('recruitingManager'),
            employeeName: formData.get('recruitingManager'),
            position: formData.get('position'),
            grade: formData.get('grade'),
            positionType: formData.get('positionType'),
            duration: formData.get('duration'),
            basicPay: formData.get('basicPay'),
            houseAllowance: formData.get('houseAllowance'),
            resources: formData.getAll('resources'),
            budgeted: formData.get('budgeted'),
            costCentre: formData.get('costCentre'),
            recruitmentSource: formData.get('recruitmentSource'),
            reportDate: reportDate,
            reasonsForRecruiting: formData.get('reasonsForRecruiting'),
            submissionDate: submissionDate,
            status: 'Awaiting Section Manager',
            date: new Date().toLocaleDateString(),
            signedFile: signedFile,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Personnel Request Data:', JSON.stringify(newRequest));
          sendEmail(
            personnelApprovers[0].email,
            'New Personnel Request - Pending Your Approval',
            `New personnel request for ${newRequest.position} by ${newRequest.recruitingManager} submitted on ${newRequest.submissionDate}, joining date: ${newRequest.reportDate}. Please review and approve.`
          );
          showAlert(`Personnel Request for ${newRequest.recruitingManager} submitted successfully!`, 'success');
          this.reset();
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          submitRequest(null);
        }
      });

      // Handle Account Request Form Submission
      accountForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Account Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['accountRequestDate', 'accountReportDate', 'companyName', 'requesterName', 'requesterPosition', 'requesterTelephoneExt', 'department', 'division', 'firstName', 'lastName', 'jobTitle', 'employeeStatus', 'physicalLocation', 'proposedUserPosition', 'pfNumber', 'userDepartment', 'userDivision', 'validity'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('userType')) {
          isValid = false;
          missingFields.push('userType');
        }
        if (formData.get('outsourced') === 'Yes' && !formData.get('entityName')) {
          isValid = false;
          missingFields.push('entityName');
        }
        if (formData.get('validity') === 'Short Period' && !formData.get('validityDuration')) {
          isValid = false;
          missingFields.push('validityDuration');
        }
        const selectedSystems = formData.getAll('systems');
        if (selectedSystems.length === 0) {
          isValid = false;
          missingFields.push('systems');
        }
        for (const system of selectedSystems) {
          if (!formData.get(`roles_${system}`) || !formData.get(`reasons_${system}`)) {
            isValid = false;
            missingFields.push(`roles_${system}`, `reasons_${system}`);
          }
          if (formData.get(`roles_${system}`) === 'Custom' && !formData.get(`customRole_${system}`)) {
            isValid = false;
            missingFields.push(`customRole_${system}`);
          }
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const file = formData.get('signedDocument');
        const sapFile = formData.get('signedSAPDocument');
        const systemDetails = {};
        selectedSystems.forEach(system => {
          const role = formData.get(`roles_${system}`) === 'Custom' ? formData.get(`customRole_${system}`) : formData.get(`roles_${system}`);
          systemDetails[system] = {
            role: role,
            reasons: formData.get(`reasons_${system}`)
          };
        });

        const accountRequestDate = formData.get('accountRequestDate');
        const accountReportDate = formData.get('accountReportDate');
        const submissionDate = accountRequestDate || getLocalDateString();
        
        if (accountRequestDate && accountReportDate) {
          const requestDate = new Date(accountRequestDate);
          const reportDate = new Date(accountReportDate);
          const daysDiff = Math.ceil((reportDate - requestDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff < 14) {
            if (!confirm(`Warning: Only ${daysDiff} days between request date and report date. Minimum 14 days required. Do you want to proceed anyway?`)) {
              return;
            }
          }
        }

        const accountExpiryDate = formData.get('accountExpiryDate');

        const submitRequest = (signedFile, signedSAPFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'account',
            date: new Date().toLocaleDateString(),
            submissionDate: submissionDate,
            companyName: formData.get('companyName'),
            requesterName: formData.get('requesterName'),
            requesterPosition: formData.get('requesterPosition'),
            requesterTelephoneExt: formData.get('requesterTelephoneExt'),
            department: formData.get('department'),
            division: formData.get('division'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            jobTitle: formData.get('jobTitle'),
            employeeStatus: formData.get('employeeStatus'),
            ictRequests: formData.getAll('ictRequests'),
            physicalLocation: formData.get('physicalLocation'),
            intranetSites: formData.get('intranetSites'),
            sharedFolders: formData.get('sharedFolders'),
            accountExpiryDate: accountExpiryDate,
            othersAccess: formData.get('othersAccess'),
            accountSetupBy: formData.get('accountSetupBy'),
            groupAction: formData.getAll('groupAction'),
            mailGroupNames: formData.get('mailGroupNames'),
            picGroup: formData.get('picGroup'),
            mailboxAction: formData.getAll('mailboxAction'),
            sharedMailboxNames: formData.get('sharedMailboxNames'),
            picMailbox: formData.get('picMailbox'),
            proposedUserPosition: formData.get('proposedUserPosition'),
            pfNumber: formData.get('pfNumber'),
            userDepartment: formData.get('userDepartment'),
            userDivision: formData.get('userDivision'),
            userType: formData.get('userType'),
            outsourced: formData.get('outsourced') === 'Yes',
            entityName: formData.get('entityName'),
            systems: selectedSystems,
            systemDetails: systemDetails,
            validity: formData.get('validity'),
            validityDuration: formData.get('validityDuration'),
            status: 'Awaiting Section Manager',
            signedFile: signedFile,
            signedSAPFile: signedSAPFile,
            accountRequestDate: accountRequestDate,
            accountReportDate: accountReportDate,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Account Request Data:', JSON.stringify(newRequest));
          sendEmail(
            accountApprovers[0].email,
            'New Account Request - Pending Your Approval',
            `New account request by ${newRequest.requesterName} submitted on ${newRequest.submissionDate}. Systems: ${selectedSystems.join(', ')}. Please review and approve.`
          );
          showAlert(`Account Request for ${newRequest.requesterName} submitted successfully!`, 'success');
          this.reset();
          systemFields.innerHTML = '';
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0 && sapFile && sapFile.size > 0) {
          const reader1 = new FileReader();
          reader1.onload = function (e) {
            const reader2 = new FileReader();
            reader2.onload = function (f) {
              console.log('Files read successfully');
              submitRequest(e.target.result, f.target.result);
            };
            reader2.onerror = function (f) {
              console.error('SAP file reading failed:', f);
              showAlert('Failed to read uploaded SAP file.', 'error');
            };
            reader2.readAsDataURL(sapFile);
          };
          reader1.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader1.readAsDataURL(file);
        } else if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result, null);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else if (sapFile && sapFile.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('SAP file read successfully');
            submitRequest(null, e.target.result);
          };
          reader.onerror = function (e) {
            console.error('SAP file reading failed:', e);
            showAlert('Failed to read uploaded SAP file.', 'error');
          };
          reader.readAsDataURL(sapFile);
        } else {
          submitRequest(null, null);
        }
      });

      // Navigation between sections
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-section');
          sections.forEach(s => s.classList.remove('active'));
          const targetSection = document.getElementById(target);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (target === 'approval') renderApproval();
          if (target === 'history') renderHistory();
          if (target === 'requests') renderRequests();
          if (target === 'it-manager') renderITManager();
          if (target === 'task-dashboard') renderTaskDashboard();
        });
      });

      // Approval Workflow
      window.approveRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (!req) {
          console.log(`Request ${id} not found`);
          showAlert(`Request ${id} not found.`, 'error');
          return;
        }
        
        const approvers = type === 'personnel' ? personnelApprovers : accountApprovers;
        const currentApproverIndex = approvers.findIndex(a => req.status.trim() === `Awaiting ${a.role}`);
        console.log(`Approving ${id}, Status: ${req.status}, Index: ${currentApproverIndex}`);

        if (currentApproverIndex === -1) {
          showAlert('Invalid approval stage for request ' + id, 'error');
          return;
        }

        const approverRole = approvers[currentApproverIndex].role;
        if (!req.approvalDates) req.approvalDates = {};
        req.approvalDates[approverRole] = new Date().toLocaleDateString();

        if (currentApproverIndex < approvers.length - 1) {
          req.status = `Awaiting ${approvers[currentApproverIndex + 1].role}`;
          showAlert(`Request ${id} approved by ${approverRole}.`, 'success');
          sendEmail(
            approvers[currentApproverIndex + 1].email,
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request - Pending Your Approval`,
            `A ${type} request ${id} is pending your approval. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}, Submitted: ${req.submissionDate}. Please review.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        } else {
          req.status = 'Pending IT Manager';
          showAlert(`Request ${id} fully approved! Now pending IT Manager assignment.`, 'success');
          sendEmail(
            'it.manager@cfao.com',
            'New Request Ready for IT Assignment',
            `A ${type} request ${id} has been fully approved and is ready for IT team assignment. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Please assign to appropriate IT teams.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        }
        renderApproval();
        renderHistory();
        renderITManager();
        renderRequests();
      };

      window.rejectRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Rejected';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request Rejected`,
            `${type} request ${id} has been rejected.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} rejected.`, 'error');
        }
        renderApproval();
        renderHistory();
        renderRequests();
      };

      window.uploadSignedFile = function (id) {
        const fileInput = document.getElementById(`signedFile_${id}`);
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const req = requests.find(r => r.id === id);
            if (req) {
              req.signedFile = e.target.result;
              console.log(`Signed file uploaded for request ${id}:`, req.signedFile);
              showAlert(`Signed file uploaded for request ${id}.`, 'success');
              renderApproval();
              renderHistory();
            }
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          showAlert('Please select a file to upload.', 'error');
        }
      };

      window.markInProgress = function (id) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'In Progress';
          showAlert(`Request ${id} marked as In Progress.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.markComplete = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Completed';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `Request Completed`,
            `Request ${id} has been completed.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} completed.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.assignToITTeams = function (requestId) {
        const req = requests.find(r => r.id === requestId);
        if (!req) {
          showAlert('Request not found.', 'error');
          return;
        }

        const checkboxes = document.querySelectorAll(`input[name="assign_${requestId}"]:checked`);
        const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

        if (selectedTeams.length === 0) {
          showAlert('Please select at least one IT team.', 'error');
          return;
        }

        req.assignedTeams = selectedTeams;
        req.status = 'In Progress';
        if (!req.itTasks) req.itTasks = {};

        selectedTeams.forEach(team => {
          if (!req.itTasks[team]) {
            req.itTasks[team] = { status: 'Not Started', notes: '', assignee: '' };
          }
          const assigneeInput = document.querySelector(`[name="assign_${requestId}_assignee_${team}"]`);
          if (assigneeInput) {
            req.itTasks[team].assignee = assigneeInput.value.trim();
          }
        });

        selectedTeams.forEach(team => {
          const teamInfo = itTeams[team];
          if (teamInfo) {
            sendEmail(
              teamInfo.email,
              'New IT Task Assigned',
              `A new IT task has been assigned to ${team}. Request ID: ${requestId}, Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Assigned to: ${req.itTasks[team].assignee || 'Unassigned'}. Please review and update status.`
            ).catch(() => console.log(`Email failed for ${team}, proceeding without notification`));
          }
        });

        showAlert(`Request ${requestId} assigned to ${selectedTeams.length} IT team(s).`, 'success');
        renderITManager();
        renderHistory();
        renderTaskDashboard();
        renderRequests();
      };

      function renderTaskDashboard() {
        const taskDashboard = document.getElementById('taskDashboardContent');
        const currentRole = currentUserRole || document.getElementById('userRoleBadge')?.textContent.trim();
        
        if (!currentRole) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const teamName = Object.keys(itTeams).find(team => 
          currentRole === team || currentRole.includes(team)
        );
        
        if (!teamName) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const assignedRequests = requests.filter(r => 
          r.assignedTeams && r.assignedTeams.includes(teamName) && 
          (r.status === 'In Progress' || r.status === 'Completed' || r.status === 'Pending')
        );

        if (assignedRequests.length === 0) {
          taskDashboard.innerHTML = `<p>No tasks assigned to ${teamName}.</p>`;
          return;
        }

        let html = '<div class="task-list">';
        assignedRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const taskStatus = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].status : 'Not Started';
          const taskNotes = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].notes : '';
          const assignee = r.itTasks && r.itTasks[teamName] ? (r.itTasks[teamName].assignee || 'Unassigned') : 'Unassigned';
          
          html += `
            <div class="task-card">
              <h4>Request ${r.id} - ${employeeName}</h4>
              <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
              <p><strong>Request Date:</strong> ${r.submissionDate || r.date}</p>
              <p><strong>Assignee:</strong> ${assignee}</p>
              <p><strong>Current Status:</strong> ${taskStatus}</p>
              <div class="task-actions">
                <select id="taskStatus_${r.id}_${teamName}" onchange="updateTaskStatus('${r.id}', '${teamName}')">
                  <option value="Not Started" ${taskStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  <option value="In Progress" ${taskStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Completed" ${taskStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
                <textarea id="taskNotes_${r.id}_${teamName}" placeholder="Add completion notes..." rows="3">${taskNotes}</textarea>
                <button onclick="saveTaskNotes('${r.id}', '${teamName}')">Save Notes</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        taskDashboard.innerHTML = html;
      }

      // REQUESTS TAB RENDERING
      function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const filterValue = document.getElementById('requestsFilter')?.value || 'all';
        
        let filteredRequests = requests;
        if (filterValue === 'personnel') {
          filteredRequests = requests.filter(r => r.type === 'personnel');
        } else if (filterValue === 'account') {
          filteredRequests = requests.filter(r => r.type === 'account');
        }

        if (filteredRequests.length === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No requests found.</td></tr>';
          return;
        }

        requestsTableBody.innerHTML = '';
        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || 'N/A');
          
          const downloadButtons = r.type === 'personnel' 
            ? `<button onclick="downloadHR7PDF('${r.id}')" class="download-btn">ðŸ“„ Download HR7</button>`
            : `<button onclick="downloadCorp6PDF('${r.id}')" class="download-btn">ðŸ“„ Download Corp6</button><br/>
               ${r.systems && r.systems.length > 0 ? r.systems.map(sys => 
                 `<button onclick="downloadCorp5PDF('${r.id}', '${sys}')" class="download-btn-small">ðŸ“‹ ${sys} Form</button>`
               ).join(' ') : ''}`;
          
          requestsTableBody.innerHTML += `
            <tr>
              <td><strong>${r.id}</strong></td>
              <td><span class="type-badge type-${r.type}">${r.type.toUpperCase()}</span></td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td><span class="status-badge status-${r.status.toLowerCase().replace(/\s+/g, '-')}">${r.status}</span></td>
              <td>${downloadButtons}</td>
            </tr>`;
        });
      }

      window.filterRequests = function() {
        renderRequests();
      };

      // Handle Personnel Request Form Submission
      personnelForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Personnel Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['dateRequested', 'recruitingManager', 'position', 'grade', 'basicPay', 'houseAllowance', 'budgeted', 'costCentre', 'reportDate', 'reasonsForRecruiting'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('positionType')) {
          isValid = false;
          missingFields.push('positionType');
        }
        if (!formData.get('recruitmentSource')) {
          isValid = false;
          missingFields.push('recruitmentSource');
        }
        if ((formData.get('positionType') === 'Contract' || formData.get('positionType') === 'Intern') && !formData.get('duration')) {
          isValid = false;
          missingFields.push('duration');
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const reportDate = formData.get('reportDate');
        const submissionDate = getLocalDateString();
        const daysDiff = Math.ceil((new Date(reportDate) - new Date(submissionDate)) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 14) {
          if (!confirm(`Warning: Only ${daysDiff} days until joining date. Minimum 14 days required. Do you want to proceed anyway?`)) {
            return;
          }
        }

        const file = formData.get('jobProfile');
        const submitRequest = (signedFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'personnel',
            dateRequested: formData.get('dateRequested'),
            recruitingManager: formData.get('recruitingManager'),
            employeeName: formData.get('recruitingManager'),
            position: formData.get('position'),
            grade: formData.get('grade'),
            positionType: formData.get('positionType'),
            duration: formData.get('duration'),
            basicPay: formData.get('basicPay'),
            houseAllowance: formData.get('houseAllowance'),
            resources: formData.getAll('resources'),
            budgeted: formData.get('budgeted'),
            costCentre: formData.get('costCentre'),
            recruitmentSource: formData.get('recruitmentSource'),
            reportDate: reportDate,
            reasonsForRecruiting: formData.get('reasonsForRecruiting'),
            submissionDate: submissionDate,
            status: 'Awaiting Section Manager',
            date: new Date().toLocaleDateString(),
            signedFile: signedFile,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Personnel Request Data:', JSON.stringify(newRequest));
          sendEmail(
            personnelApprovers[0].email,
            'New Personnel Request - Pending Your Approval',
            `New personnel request for ${newRequest.position} by ${newRequest.recruitingManager} submitted on ${newRequest.submissionDate}, joining date: ${newRequest.reportDate}. Please review and approve.`
          );
          showAlert(`Personnel Request for ${newRequest.recruitingManager} submitted successfully!`, 'success');
          this.reset();
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          submitRequest(null);
        }
      });

      // Handle Account Request Form Submission
      accountForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Account Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['accountRequestDate', 'accountReportDate', 'companyName', 'requesterName', 'requesterPosition', 'requesterTelephoneExt', 'department', 'division', 'firstName', 'lastName', 'jobTitle', 'employeeStatus', 'physicalLocation', 'proposedUserPosition', 'pfNumber', 'userDepartment', 'userDivision', 'validity'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('userType')) {
          isValid = false;
          missingFields.push('userType');
        }
        if (formData.get('outsourced') === 'Yes' && !formData.get('entityName')) {
          isValid = false;
          missingFields.push('entityName');
        }
        if (formData.get('validity') === 'Short Period' && !formData.get('validityDuration')) {
          isValid = false;
          missingFields.push('validityDuration');
        }
        const selectedSystems = formData.getAll('systems');
        if (selectedSystems.length === 0) {
          isValid = false;
          missingFields.push('systems');
        }
        for (const system of selectedSystems) {
          if (!formData.get(`roles_${system}`) || !formData.get(`reasons_${system}`)) {
            isValid = false;
            missingFields.push(`roles_${system}`, `reasons_${system}`);
          }
          if (formData.get(`roles_${system}`) === 'Custom' && !formData.get(`customRole_${system}`)) {
            isValid = false;
            missingFields.push(`customRole_${system}`);
          }
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const file = formData.get('signedDocument');
        const sapFile = formData.get('signedSAPDocument');
        const systemDetails = {};
        selectedSystems.forEach(system => {
          const role = formData.get(`roles_${system}`) === 'Custom' ? formData.get(`customRole_${system}`) : formData.get(`roles_${system}`);
          systemDetails[system] = {
            role: role,
            reasons: formData.get(`reasons_${system}`)
          };
        });

        const accountRequestDate = formData.get('accountRequestDate');
        const accountReportDate = formData.get('accountReportDate');
        const submissionDate = accountRequestDate || getLocalDateString();
        
        if (accountRequestDate && accountReportDate) {
          const requestDate = new Date(accountRequestDate);
          const reportDate = new Date(accountReportDate);
          const daysDiff = Math.ceil((reportDate - requestDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff < 14) {
            if (!confirm(`Warning: Only ${daysDiff} days between request date and report date. Minimum 14 days required. Do you want to proceed anyway?`)) {
              return;
            }
          }
        }

        const accountExpiryDate = formData.get('accountExpiryDate');

        const submitRequest = (signedFile, signedSAPFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'account',
            date: new Date().toLocaleDateString(),
            submissionDate: submissionDate,
            companyName: formData.get('companyName'),
            requesterName: formData.get('requesterName'),
            requesterPosition: formData.get('requesterPosition'),
            requesterTelephoneExt: formData.get('requesterTelephoneExt'),
            department: formData.get('department'),
            division: formData.get('division'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            jobTitle: formData.get('jobTitle'),
            employeeStatus: formData.get('employeeStatus'),
            ictRequests: formData.getAll('ictRequests'),
            physicalLocation: formData.get('physicalLocation'),
            intranetSites: formData.get('intranetSites'),
            sharedFolders: formData.get('sharedFolders'),
            accountExpiryDate: accountExpiryDate,
            othersAccess: formData.get('othersAccess'),
            accountSetupBy: formData.get('accountSetupBy'),
            groupAction: formData.getAll('groupAction'),
            mailGroupNames: formData.get('mailGroupNames'),
            picGroup: formData.get('picGroup'),
            mailboxAction: formData.getAll('mailboxAction'),
            sharedMailboxNames: formData.get('sharedMailboxNames'),
            picMailbox: formData.get('picMailbox'),
            proposedUserPosition: formData.get('proposedUserPosition'),
            pfNumber: formData.get('pfNumber'),
            userDepartment: formData.get('userDepartment'),
            userDivision: formData.get('userDivision'),
            userType: formData.get('userType'),
            outsourced: formData.get('outsourced') === 'Yes',
            entityName: formData.get('entityName'),
            systems: selectedSystems,
            systemDetails: systemDetails,
            validity: formData.get('validity'),
            validityDuration: formData.get('validityDuration'),
            status: 'Awaiting Section Manager',
            signedFile: signedFile,
            signedSAPFile: signedSAPFile,
            accountRequestDate: accountRequestDate,
            accountReportDate: accountReportDate,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Account Request Data:', JSON.stringify(newRequest));
          sendEmail(
            accountApprovers[0].email,
            'New Account Request - Pending Your Approval',
            `New account request by ${newRequest.requesterName} submitted on ${newRequest.submissionDate}. Systems: ${selectedSystems.join(', ')}. Please review and approve.`
          );
          showAlert(`Account Request for ${newRequest.requesterName} submitted successfully!`, 'success');
          this.reset();
          systemFields.innerHTML = '';
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0 && sapFile && sapFile.size > 0) {
          const reader1 = new FileReader();
          reader1.onload = function (e) {
            const reader2 = new FileReader();
            reader2.onload = function (f) {
              console.log('Files read successfully');
              submitRequest(e.target.result, f.target.result);
            };
            reader2.onerror = function (f) {
              console.error('SAP file reading failed:', f);
              showAlert('Failed to read uploaded SAP file.', 'error');
            };
            reader2.readAsDataURL(sapFile);
          };
          reader1.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader1.readAsDataURL(file);
        } else if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result, null);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else if (sapFile && sapFile.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('SAP file read successfully');
            submitRequest(null, e.target.result);
          };
          reader.onerror = function (e) {
            console.error('SAP file reading failed:', e);
            showAlert('Failed to read uploaded SAP file.', 'error');
          };
          reader.readAsDataURL(sapFile);
        } else {
          submitRequest(null, null);
        }
      });

      // Navigation between sections
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-section');
          sections.forEach(s => s.classList.remove('active'));
          const targetSection = document.getElementById(target);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (target === 'approval') renderApproval();
          if (target === 'history') renderHistory();
          if (target === 'requests') renderRequests();
          if (target === 'it-manager') renderITManager();
          if (target === 'task-dashboard') renderTaskDashboard();
        });
      });

      // Approval Workflow
      window.approveRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (!req) {
          console.log(`Request ${id} not found`);
          showAlert(`Request ${id} not found.`, 'error');
          return;
        }
        
        const approvers = type === 'personnel' ? personnelApprovers : accountApprovers;
        const currentApproverIndex = approvers.findIndex(a => req.status.trim() === `Awaiting ${a.role}`);
        console.log(`Approving ${id}, Status: ${req.status}, Index: ${currentApproverIndex}`);

        if (currentApproverIndex === -1) {
          showAlert('Invalid approval stage for request ' + id, 'error');
          return;
        }

        const approverRole = approvers[currentApproverIndex].role;
        if (!req.approvalDates) req.approvalDates = {};
        req.approvalDates[approverRole] = new Date().toLocaleDateString();

        if (currentApproverIndex < approvers.length - 1) {
          req.status = `Awaiting ${approvers[currentApproverIndex + 1].role}`;
          showAlert(`Request ${id} approved by ${approverRole}.`, 'success');
          sendEmail(
            approvers[currentApproverIndex + 1].email,
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request - Pending Your Approval`,
            `A ${type} request ${id} is pending your approval. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}, Submitted: ${req.submissionDate}. Please review.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        } else {
          req.status = 'Pending IT Manager';
          showAlert(`Request ${id} fully approved! Now pending IT Manager assignment.`, 'success');
          sendEmail(
            'it.manager@cfao.com',
            'New Request Ready for IT Assignment',
            `A ${type} request ${id} has been fully approved and is ready for IT team assignment. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Please assign to appropriate IT teams.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        }
        renderApproval();
        renderHistory();
        renderITManager();
        renderRequests();
      };

      window.rejectRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Rejected';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request Rejected`,
            `${type} request ${id} has been rejected.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} rejected.`, 'error');
        }
        renderApproval();
        renderHistory();
        renderRequests();
      };

      window.uploadSignedFile = function (id) {
        const fileInput = document.getElementById(`signedFile_${id}`);
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const req = requests.find(r => r.id === id);
            if (req) {
              req.signedFile = e.target.result;
              console.log(`Signed file uploaded for request ${id}:`, req.signedFile);
              showAlert(`Signed file uploaded for request ${id}.`, 'success');
              renderApproval();
              renderHistory();
            }
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          showAlert('Please select a file to upload.', 'error');
        }
      };

      window.markInProgress = function (id) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'In Progress';
          showAlert(`Request ${id} marked as In Progress.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.markComplete = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Completed';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `Request Completed`,
            `Request ${id} has been completed.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} completed.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.assignToITTeams = function (requestId) {
        const req = requests.find(r => r.id === requestId);
        if (!req) {
          showAlert('Request not found.', 'error');
          return;
        }

        const checkboxes = document.querySelectorAll(`input[name="assign_${requestId}"]:checked`);
        const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

        if (selectedTeams.length === 0) {
          showAlert('Please select at least one IT team.', 'error');
          return;
        }

        req.assignedTeams = selectedTeams;
        req.status = 'In Progress';
        if (!req.itTasks) req.itTasks = {};

        selectedTeams.forEach(team => {
          if (!req.itTasks[team]) {
            req.itTasks[team] = { status: 'Not Started', notes: '', assignee: '' };
          }
          const assigneeInput = document.querySelector(`[name="assign_${requestId}_assignee_${team}"]`);
          if (assigneeInput) {
            req.itTasks[team].assignee = assigneeInput.value.trim();
          }
        });

        selectedTeams.forEach(team => {
          const teamInfo = itTeams[team];
          if (teamInfo) {
            sendEmail(
              teamInfo.email,
              'New IT Task Assigned',
              `A new IT task has been assigned to ${team}. Request ID: ${requestId}, Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Assigned to: ${req.itTasks[team].assignee || 'Unassigned'}. Please review and update status.`
            ).catch(() => console.log(`Email failed for ${team}, proceeding without notification`));
          }
        });

        showAlert(`Request ${requestId} assigned to ${selectedTeams.length} IT team(s).`, 'success');
        renderITManager();
        renderHistory();
        renderTaskDashboard();
        renderRequests();
      };

      function renderTaskDashboard() {
        const taskDashboard = document.getElementById('taskDashboardContent');
        const currentRole = currentUserRole || document.getElementById('userRoleBadge')?.textContent.trim();
        
        if (!currentRole) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const teamName = Object.keys(itTeams).find(team => 
          currentRole === team || currentRole.includes(team)
        );
        
        if (!teamName) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const assignedRequests = requests.filter(r => 
          r.assignedTeams && r.assignedTeams.includes(teamName) && 
          (r.status === 'In Progress' || r.status === 'Completed' || r.status === 'Pending')
        );

        if (assignedRequests.length === 0) {
          taskDashboard.innerHTML = `<p>No tasks assigned to ${teamName}.</p>`;
          return;
        }

        let html = '<div class="task-list">';
        assignedRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const taskStatus = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].status : 'Not Started';
          const taskNotes = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].notes : '';
          const assignee = r.itTasks && r.itTasks[teamName] ? (r.itTasks[teamName].assignee || 'Unassigned') : 'Unassigned';
          
          html += `
            <div class="task-card">
              <h4>Request ${r.id} - ${employeeName}</h4>
              <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
              <p><strong>Request Date:</strong> ${r.submissionDate || r.date}</p>
              <p><strong>Assignee:</strong> ${assignee}</p>
              <p><strong>Current Status:</strong> ${taskStatus}</p>
              <div class="task-actions">
                <select id="taskStatus_${r.id}_${teamName}" onchange="updateTaskStatus('${r.id}', '${teamName}')">
                  <option value="Not Started" ${taskStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  <option value="In Progress" ${taskStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Completed" ${taskStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
                <textarea id="taskNotes_${r.id}_${teamName}" placeholder="Add completion notes..." rows="3">${taskNotes}</textarea>
                <button onclick="saveTaskNotes('${r.id}', '${teamName}')">Save Notes</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        taskDashboard.innerHTML = html;
      }

      // REQUESTS TAB RENDERING
      function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const filterValue = document.getElementById('requestsFilter')?.value || 'all';
        
        let filteredRequests = requests;
        if (filterValue === 'personnel') {
          filteredRequests = requests.filter(r => r.type === 'personnel');
        } else if (filterValue === 'account') {
          filteredRequests = requests.filter(r => r.type === 'account');
        }

        if (filteredRequests.length === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No requests found.</td></tr>';
          return;
        }

        requestsTableBody.innerHTML = '';
        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || 'N/A');
          
          const downloadButtons = r.type === 'personnel' 
            ? `<button onclick="downloadHR7PDF('${r.id}')" class="download-btn">ðŸ“„ Download HR7</button>`
            : `<button onclick="downloadCorp6PDF('${r.id}')" class="download-btn">ðŸ“„ Download Corp6</button><br/>
               ${r.systems && r.systems.length > 0 ? r.systems.map(sys => 
                 `<button onclick="downloadCorp5PDF('${r.id}', '${sys}')" class="download-btn-small">ðŸ“‹ ${sys} Form</button>`
               ).join(' ') : ''}`;
          
          requestsTableBody.innerHTML += `
            <tr>
              <td><strong>${r.id}</strong></td>
              <td><span class="type-badge type-${r.type}">${r.type.toUpperCase()}</span></td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td><span class="status-badge status-${r.status.toLowerCase().replace(/\s+/g, '-')}">${r.status}</span></td>
              <td>${downloadButtons}</td>
            </tr>`;
        });
      }

      window.filterRequests = function() {
        renderRequests();
      };

      // Handle Personnel Request Form Submission
      personnelForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Personnel Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['dateRequested', 'recruitingManager', 'position', 'grade', 'basicPay', 'houseAllowance', 'budgeted', 'costCentre', 'reportDate', 'reasonsForRecruiting'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('positionType')) {
          isValid = false;
          missingFields.push('positionType');
        }
        if (!formData.get('recruitmentSource')) {
          isValid = false;
          missingFields.push('recruitmentSource');
        }
        if ((formData.get('positionType') === 'Contract' || formData.get('positionType') === 'Intern') && !formData.get('duration')) {
          isValid = false;
          missingFields.push('duration');
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const reportDate = formData.get('reportDate');
        const submissionDate = getLocalDateString();
        const daysDiff = Math.ceil((new Date(reportDate) - new Date(submissionDate)) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 14) {
          if (!confirm(`Warning: Only ${daysDiff} days until joining date. Minimum 14 days required. Do you want to proceed anyway?`)) {
            return;
          }
        }

        const file = formData.get('jobProfile');
        const submitRequest = (signedFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'personnel',
            dateRequested: formData.get('dateRequested'),
            recruitingManager: formData.get('recruitingManager'),
            employeeName: formData.get('recruitingManager'),
            position: formData.get('position'),
            grade: formData.get('grade'),
            positionType: formData.get('positionType'),
            duration: formData.get('duration'),
            basicPay: formData.get('basicPay'),
            houseAllowance: formData.get('houseAllowance'),
            resources: formData.getAll('resources'),
            budgeted: formData.get('budgeted'),
            costCentre: formData.get('costCentre'),
            recruitmentSource: formData.get('recruitmentSource'),
            reportDate: reportDate,
            reasonsForRecruiting: formData.get('reasonsForRecruiting'),
            submissionDate: submissionDate,
            status: 'Awaiting Section Manager',
            date: new Date().toLocaleDateString(),
            signedFile: signedFile,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Personnel Request Data:', JSON.stringify(newRequest));
          sendEmail(
            personnelApprovers[0].email,
            'New Personnel Request - Pending Your Approval',
            `New personnel request for ${newRequest.position} by ${newRequest.recruitingManager} submitted on ${newRequest.submissionDate}, joining date: ${newRequest.reportDate}. Please review and approve.`
          );
          showAlert(`Personnel Request for ${newRequest.recruitingManager} submitted successfully!`, 'success');
          this.reset();
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          submitRequest(null);
        }
      });

      // Handle Account Request Form Submission
      accountForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Account Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['accountRequestDate', 'accountReportDate', 'companyName', 'requesterName', 'requesterPosition', 'requesterTelephoneExt', 'department', 'division', 'firstName', 'lastName', 'jobTitle', 'employeeStatus', 'physicalLocation', 'proposedUserPosition', 'pfNumber', 'userDepartment', 'userDivision', 'validity'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('userType')) {
          isValid = false;
          missingFields.push('userType');
        }
        if (formData.get('outsourced') === 'Yes' && !formData.get('entityName')) {
          isValid = false;
          missingFields.push('entityName');
        }
        if (formData.get('validity') === 'Short Period' && !formData.get('validityDuration')) {
          isValid = false;
          missingFields.push('validityDuration');
        }
        const selectedSystems = formData.getAll('systems');
        if (selectedSystems.length === 0) {
          isValid = false;
          missingFields.push('systems');
        }
        for (const system of selectedSystems) {
          if (!formData.get(`roles_${system}`) || !formData.get(`reasons_${system}`)) {
            isValid = false;
            missingFields.push(`roles_${system}`, `reasons_${system}`);
          }
          if (formData.get(`roles_${system}`) === 'Custom' && !formData.get(`customRole_${system}`)) {
            isValid = false;
            missingFields.push(`customRole_${system}`);
          }
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const file = formData.get('signedDocument');
        const sapFile = formData.get('signedSAPDocument');
        const systemDetails = {};
        selectedSystems.forEach(system => {
          const role = formData.get(`roles_${system}`) === 'Custom' ? formData.get(`customRole_${system}`) : formData.get(`roles_${system}`);
          systemDetails[system] = {
            role: role,
            reasons: formData.get(`reasons_${system}`)
          };
        });

        const accountRequestDate = formData.get('accountRequestDate');
        const accountReportDate = formData.get('accountReportDate');
        const submissionDate = accountRequestDate || getLocalDateString();
        
        if (accountRequestDate && accountReportDate) {
          const requestDate = new Date(accountRequestDate);
          const reportDate = new Date(accountReportDate);
          const daysDiff = Math.ceil((reportDate - requestDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff < 14) {
            if (!confirm(`Warning: Only ${daysDiff} days between request date and report date. Minimum 14 days required. Do you want to proceed anyway?`)) {
              return;
            }
          }
        }

        const accountExpiryDate = formData.get('accountExpiryDate');

        const submitRequest = (signedFile, signedSAPFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'account',
            date: new Date().toLocaleDateString(),
            submissionDate: submissionDate,
            companyName: formData.get('companyName'),
            requesterName: formData.get('requesterName'),
            requesterPosition: formData.get('requesterPosition'),
            requesterTelephoneExt: formData.get('requesterTelephoneExt'),
            department: formData.get('department'),
            division: formData.get('division'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            jobTitle: formData.get('jobTitle'),
            employeeStatus: formData.get('employeeStatus'),
            ictRequests: formData.getAll('ictRequests'),
            physicalLocation: formData.get('physicalLocation'),
            intranetSites: formData.get('intranetSites'),
            sharedFolders: formData.get('sharedFolders'),
            accountExpiryDate: accountExpiryDate,
            othersAccess: formData.get('othersAccess'),
            accountSetupBy: formData.get('accountSetupBy'),
            groupAction: formData.getAll('groupAction'),
            mailGroupNames: formData.get('mailGroupNames'),
            picGroup: formData.get('picGroup'),
            mailboxAction: formData.getAll('mailboxAction'),
            sharedMailboxNames: formData.get('sharedMailboxNames'),
            picMailbox: formData.get('picMailbox'),
            proposedUserPosition: formData.get('proposedUserPosition'),
            pfNumber: formData.get('pfNumber'),
            userDepartment: formData.get('userDepartment'),
            userDivision: formData.get('userDivision'),
            userType: formData.get('userType'),
            outsourced: formData.get('outsourced') === 'Yes',
            entityName: formData.get('entityName'),
            systems: selectedSystems,
            systemDetails: systemDetails,
            validity: formData.get('validity'),
            validityDuration: formData.get('validityDuration'),
            status: 'Awaiting Section Manager',
            signedFile: signedFile,
            signedSAPFile: signedSAPFile,
            accountRequestDate: accountRequestDate,
            accountReportDate: accountReportDate,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Account Request Data:', JSON.stringify(newRequest));
          sendEmail(
            accountApprovers[0].email,
            'New Account Request - Pending Your Approval',
            `New account request by ${newRequest.requesterName} submitted on ${newRequest.submissionDate}. Systems: ${selectedSystems.join(', ')}. Please review and approve.`
          );
          showAlert(`Account Request for ${newRequest.requesterName} submitted successfully!`, 'success');
          this.reset();
          systemFields.innerHTML = '';
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0 && sapFile && sapFile.size > 0) {
          const reader1 = new FileReader();
          reader1.onload = function (e) {
            const reader2 = new FileReader();
            reader2.onload = function (f) {
              console.log('Files read successfully');
              submitRequest(e.target.result, f.target.result);
            };
            reader2.onerror = function (f) {
              console.error('SAP file reading failed:', f);
              showAlert('Failed to read uploaded SAP file.', 'error');
            };
            reader2.readAsDataURL(sapFile);
          };
          reader1.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader1.readAsDataURL(file);
        } else if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result, null);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else if (sapFile && sapFile.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('SAP file read successfully');
            submitRequest(null, e.target.result);
          };
          reader.onerror = function (e) {
            console.error('SAP file reading failed:', e);
            showAlert('Failed to read uploaded SAP file.', 'error');
          };
          reader.readAsDataURL(sapFile);
        } else {
          submitRequest(null, null);
        }
      });

      // Navigation between sections
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-section');
          sections.forEach(s => s.classList.remove('active'));
          const targetSection = document.getElementById(target);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (target === 'approval') renderApproval();
          if (target === 'history') renderHistory();
          if (target === 'requests') renderRequests();
          if (target === 'it-manager') renderITManager();
          if (target === 'task-dashboard') renderTaskDashboard();
        });
      });

      // Approval Workflow
      window.approveRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (!req) {
          console.log(`Request ${id} not found`);
          showAlert(`Request ${id} not found.`, 'error');
          return;
        }
        
        const approvers = type === 'personnel' ? personnelApprovers : accountApprovers;
        const currentApproverIndex = approvers.findIndex(a => req.status.trim() === `Awaiting ${a.role}`);
        console.log(`Approving ${id}, Status: ${req.status}, Index: ${currentApproverIndex}`);

        if (currentApproverIndex === -1) {
          showAlert('Invalid approval stage for request ' + id, 'error');
          return;
        }

        const approverRole = approvers[currentApproverIndex].role;
        if (!req.approvalDates) req.approvalDates = {};
        req.approvalDates[approverRole] = new Date().toLocaleDateString();

        if (currentApproverIndex < approvers.length - 1) {
          req.status = `Awaiting ${approvers[currentApproverIndex + 1].role}`;
          showAlert(`Request ${id} approved by ${approverRole}.`, 'success');
          sendEmail(
            approvers[currentApproverIndex + 1].email,
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request - Pending Your Approval`,
            `A ${type} request ${id} is pending your approval. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}, Submitted: ${req.submissionDate}. Please review.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        } else {
          req.status = 'Pending IT Manager';
          showAlert(`Request ${id} fully approved! Now pending IT Manager assignment.`, 'success');
          sendEmail(
            'it.manager@cfao.com',
            'New Request Ready for IT Assignment',
            `A ${type} request ${id} has been fully approved and is ready for IT team assignment. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Please assign to appropriate IT teams.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        }
        renderApproval();
        renderHistory();
        renderITManager();
        renderRequests();
      };

      window.rejectRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Rejected';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request Rejected`,
            `${type} request ${id} has been rejected.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} rejected.`, 'error');
        }
        renderApproval();
        renderHistory();
        renderRequests();
      };

      window.uploadSignedFile = function (id) {
        const fileInput = document.getElementById(`signedFile_${id}`);
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const req = requests.find(r => r.id === id);
            if (req) {
              req.signedFile = e.target.result;
              console.log(`Signed file uploaded for request ${id}:`, req.signedFile);
              showAlert(`Signed file uploaded for request ${id}.`, 'success');
              renderApproval();
              renderHistory();
            }
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          showAlert('Please select a file to upload.', 'error');
        }
      };

      window.markInProgress = function (id) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'In Progress';
          showAlert(`Request ${id} marked as In Progress.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.markComplete = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Completed';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `Request Completed`,
            `Request ${id} has been completed.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} completed.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.assignToITTeams = function (requestId) {
        const req = requests.find(r => r.id === requestId);
        if (!req) {
          showAlert('Request not found.', 'error');
          return;
        }

        const checkboxes = document.querySelectorAll(`input[name="assign_${requestId}"]:checked`);
        const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

        if (selectedTeams.length === 0) {
          showAlert('Please select at least one IT team.', 'error');
          return;
        }

        req.assignedTeams = selectedTeams;
        req.status = 'In Progress';
        if (!req.itTasks) req.itTasks = {};

        selectedTeams.forEach(team => {
          if (!req.itTasks[team]) {
            req.itTasks[team] = { status: 'Not Started', notes: '', assignee: '' };
          }
          const assigneeInput = document.querySelector(`[name="assign_${requestId}_assignee_${team}"]`);
          if (assigneeInput) {
            req.itTasks[team].assignee = assigneeInput.value.trim();
          }
        });

        selectedTeams.forEach(team => {
          const teamInfo = itTeams[team];
          if (teamInfo) {
            sendEmail(
              teamInfo.email,
              'New IT Task Assigned',
              `A new IT task has been assigned to ${team}. Request ID: ${requestId}, Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Assigned to: ${req.itTasks[team].assignee || 'Unassigned'}. Please review and update status.`
            ).catch(() => console.log(`Email failed for ${team}, proceeding without notification`));
          }
        });

        showAlert(`Request ${requestId} assigned to ${selectedTeams.length} IT team(s).`, 'success');
        renderITManager();
        renderHistory();
        renderTaskDashboard();
        renderRequests();
      };

      function renderTaskDashboard() {
        const taskDashboard = document.getElementById('taskDashboardContent');
        const currentRole = currentUserRole || document.getElementById('userRoleBadge')?.textContent.trim();
        
        if (!currentRole) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const teamName = Object.keys(itTeams).find(team => 
          currentRole === team || currentRole.includes(team)
        );
        
        if (!teamName) {
          taskDashboard.innerHTML = '<p>Please select an IT team role to view your tasks.</p>';
          return;
        }

        const assignedRequests = requests.filter(r => 
          r.assignedTeams && r.assignedTeams.includes(teamName) && 
          (r.status === 'In Progress' || r.status === 'Completed' || r.status === 'Pending')
        );

        if (assignedRequests.length === 0) {
          taskDashboard.innerHTML = `<p>No tasks assigned to ${teamName}.</p>`;
          return;
        }

        let html = '<div class="task-list">';
        assignedRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const taskStatus = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].status : 'Not Started';
          const taskNotes = r.itTasks && r.itTasks[teamName] ? r.itTasks[teamName].notes : '';
          const assignee = r.itTasks && r.itTasks[teamName] ? (r.itTasks[teamName].assignee || 'Unassigned') : 'Unassigned';
          
          html += `
            <div class="task-card">
              <h4>Request ${r.id} - ${employeeName}</h4>
              <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
              <p><strong>Request Date:</strong> ${r.submissionDate || r.date}</p>
              <p><strong>Assignee:</strong> ${assignee}</p>
              <p><strong>Current Status:</strong> ${taskStatus}</p>
              <div class="task-actions">
                <select id="taskStatus_${r.id}_${teamName}" onchange="updateTaskStatus('${r.id}', '${teamName}')">
                  <option value="Not Started" ${taskStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                  <option value="In Progress" ${taskStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                  <option value="Completed" ${taskStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
                <textarea id="taskNotes_${r.id}_${teamName}" placeholder="Add completion notes..." rows="3">${taskNotes}</textarea>
                <button onclick="saveTaskNotes('${r.id}', '${teamName}')">Save Notes</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        taskDashboard.innerHTML = html;
      }

      // REQUESTS TAB RENDERING
      function renderRequests() {
        const requestsTableBody = document.getElementById('requestsTableBody');
        const filterValue = document.getElementById('requestsFilter')?.value || 'all';
        
        let filteredRequests = requests;
        if (filterValue === 'personnel') {
          filteredRequests = requests.filter(r => r.type === 'personnel');
        } else if (filterValue === 'account') {
          filteredRequests = requests.filter(r => r.type === 'account');
        }

        if (filteredRequests.length === 0) {
          requestsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No requests found.</td></tr>';
          return;
        }

        requestsTableBody.innerHTML = '';
        filteredRequests.forEach(r => {
          const employeeName = r.type === 'personnel' 
            ? (r.employeeName || r.recruitingManager)
            : `${r.firstName || ''} ${r.lastName || ''}`.trim() || r.requesterName;
          const department = r.department || (r.type === 'personnel' ? 'N/A' : r.userDepartment);
          const joiningDate = r.type === 'personnel' ? r.reportDate : (r.accountReportDate || r.accountRequestDate || 'N/A');
          
          const downloadButtons = r.type === 'personnel' 
            ? `<button onclick="downloadHR7PDF('${r.id}')" class="download-btn">ðŸ“„ Download HR7</button>`
            : `<button onclick="downloadCorp6PDF('${r.id}')" class="download-btn">ðŸ“„ Download Corp6</button><br/>
               ${r.systems && r.systems.length > 0 ? r.systems.map(sys => 
                 `<button onclick="downloadCorp5PDF('${r.id}', '${sys}')" class="download-btn-small">ðŸ“‹ ${sys} Form</button>`
               ).join(' ') : ''}`;
          
          requestsTableBody.innerHTML += `
            <tr>
              <td><strong>${r.id}</strong></td>
              <td><span class="type-badge type-${r.type}">${r.type.toUpperCase()}</span></td>
              <td>${employeeName}</td>
              <td>${department}</td>
              <td>${r.submissionDate || r.dateRequested || r.date}</td>
              <td>${joiningDate}</td>
              <td><span class="status-badge status-${r.status.toLowerCase().replace(/\s+/g, '-')}">${r.status}</span></td>
              <td>${downloadButtons}</td>
            </tr>`;
        });
      }

      window.filterRequests = function() {
        renderRequests();
      };

      // Handle Personnel Request Form Submission
      personnelForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Personnel Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['dateRequested', 'recruitingManager', 'position', 'grade', 'basicPay', 'houseAllowance', 'budgeted', 'costCentre', 'reportDate', 'reasonsForRecruiting'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('positionType')) {
          isValid = false;
          missingFields.push('positionType');
        }
        if (!formData.get('recruitmentSource')) {
          isValid = false;
          missingFields.push('recruitmentSource');
        }
        if ((formData.get('positionType') === 'Contract' || formData.get('positionType') === 'Intern') && !formData.get('duration')) {
          isValid = false;
          missingFields.push('duration');
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const reportDate = formData.get('reportDate');
        const submissionDate = getLocalDateString();
        const daysDiff = Math.ceil((new Date(reportDate) - new Date(submissionDate)) / (1000 * 60 * 60 * 24));
        
        if (daysDiff < 14) {
          if (!confirm(`Warning: Only ${daysDiff} days until joining date. Minimum 14 days required. Do you want to proceed anyway?`)) {
            return;
          }
        }

        const file = formData.get('jobProfile');
        const submitRequest = (signedFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'personnel',
            dateRequested: formData.get('dateRequested'),
            recruitingManager: formData.get('recruitingManager'),
            employeeName: formData.get('recruitingManager'),
            position: formData.get('position'),
            grade: formData.get('grade'),
            positionType: formData.get('positionType'),
            duration: formData.get('duration'),
            basicPay: formData.get('basicPay'),
            houseAllowance: formData.get('houseAllowance'),
            resources: formData.getAll('resources'),
            budgeted: formData.get('budgeted'),
            costCentre: formData.get('costCentre'),
            recruitmentSource: formData.get('recruitmentSource'),
            reportDate: reportDate,
            reasonsForRecruiting: formData.get('reasonsForRecruiting'),
            submissionDate: submissionDate,
            status: 'Awaiting Section Manager',
            date: new Date().toLocaleDateString(),
            signedFile: signedFile,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Personnel Request Data:', JSON.stringify(newRequest));
          sendEmail(
            personnelApprovers[0].email,
            'New Personnel Request - Pending Your Approval',
            `New personnel request for ${newRequest.position} by ${newRequest.recruitingManager} submitted on ${newRequest.submissionDate}, joining date: ${newRequest.reportDate}. Please review and approve.`
          );
          showAlert(`Personnel Request for ${newRequest.recruitingManager} submitted successfully!`, 'success');
          this.reset();
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          submitRequest(null);
        }
      });

      // Handle Account Request Form Submission
      accountForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Account Request Form submitted');
        const formData = new FormData(this);
        
        const requiredFields = ['accountRequestDate', 'accountReportDate', 'companyName', 'requesterName', 'requesterPosition', 'requesterTelephoneExt', 'department', 'division', 'firstName', 'lastName', 'jobTitle', 'employeeStatus', 'physicalLocation', 'proposedUserPosition', 'pfNumber', 'userDepartment', 'userDivision', 'validity'];
        let isValid = true;
        let missingFields = [];
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            isValid = false;
            missingFields.push(field);
          }
        }
        if (!formData.get('userType')) {
          isValid = false;
          missingFields.push('userType');
        }
        if (formData.get('outsourced') === 'Yes' && !formData.get('entityName')) {
          isValid = false;
          missingFields.push('entityName');
        }
        if (formData.get('validity') === 'Short Period' && !formData.get('validityDuration')) {
          isValid = false;
          missingFields.push('validityDuration');
        }
        const selectedSystems = formData.getAll('systems');
        if (selectedSystems.length === 0) {
          isValid = false;
          missingFields.push('systems');
        }
        for (const system of selectedSystems) {
          if (!formData.get(`roles_${system}`) || !formData.get(`reasons_${system}`)) {
            isValid = false;
            missingFields.push(`roles_${system}`, `reasons_${system}`);
          }
          if (formData.get(`roles_${system}`) === 'Custom' && !formData.get(`customRole_${system}`)) {
            isValid = false;
            missingFields.push(`customRole_${system}`);
          }
        }

        if (!isValid) {
          console.log('Validation failed for fields:', missingFields);
          showAlert(`Please fill all required fields: ${missingFields.join(', ')}`, 'error');
          return;
        }

        const file = formData.get('signedDocument');
        const sapFile = formData.get('signedSAPDocument');
        const systemDetails = {};
        selectedSystems.forEach(system => {
          const role = formData.get(`roles_${system}`) === 'Custom' ? formData.get(`customRole_${system}`) : formData.get(`roles_${system}`);
          systemDetails[system] = {
            role: role,
            reasons: formData.get(`reasons_${system}`)
          };
        });

        const accountRequestDate = formData.get('accountRequestDate');
        const accountReportDate = formData.get('accountReportDate');
        const submissionDate = accountRequestDate || getLocalDateString();
        
        if (accountRequestDate && accountReportDate) {
          const requestDate = new Date(accountRequestDate);
          const reportDate = new Date(accountReportDate);
          const daysDiff = Math.ceil((reportDate - requestDate) / (1000 * 60 * 60 * 24));
          
          if (daysDiff < 14) {
            if (!confirm(`Warning: Only ${daysDiff} days between request date and report date. Minimum 14 days required. Do you want to proceed anyway?`)) {
              return;
            }
          }
        }

        const accountExpiryDate = formData.get('accountExpiryDate');

        const submitRequest = (signedFile, signedSAPFile) => {
          const newRequest = {
            id: Date.now().toString(),
            type: 'account',
            date: new Date().toLocaleDateString(),
            submissionDate: submissionDate,
            companyName: formData.get('companyName'),
            requesterName: formData.get('requesterName'),
            requesterPosition: formData.get('requesterPosition'),
            requesterTelephoneExt: formData.get('requesterTelephoneExt'),
            department: formData.get('department'),
            division: formData.get('division'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            jobTitle: formData.get('jobTitle'),
            employeeStatus: formData.get('employeeStatus'),
            ictRequests: formData.getAll('ictRequests'),
            physicalLocation: formData.get('physicalLocation'),
            intranetSites: formData.get('intranetSites'),
            sharedFolders: formData.get('sharedFolders'),
            accountExpiryDate: accountExpiryDate,
            othersAccess: formData.get('othersAccess'),
            accountSetupBy: formData.get('accountSetupBy'),
            groupAction: formData.getAll('groupAction'),
            mailGroupNames: formData.get('mailGroupNames'),
            picGroup: formData.get('picGroup'),
            mailboxAction: formData.getAll('mailboxAction'),
            sharedMailboxNames: formData.get('sharedMailboxNames'),
            picMailbox: formData.get('picMailbox'),
            proposedUserPosition: formData.get('proposedUserPosition'),
            pfNumber: formData.get('pfNumber'),
            userDepartment: formData.get('userDepartment'),
            userDivision: formData.get('userDivision'),
            userType: formData.get('userType'),
            outsourced: formData.get('outsourced') === 'Yes',
            entityName: formData.get('entityName'),
            systems: selectedSystems,
            systemDetails: systemDetails,
            validity: formData.get('validity'),
            validityDuration: formData.get('validityDuration'),
            status: 'Awaiting Section Manager',
            signedFile: signedFile,
            signedSAPFile: signedSAPFile,
            accountRequestDate: accountRequestDate,
            accountReportDate: accountReportDate,
            approvalDates: {},
            assignedTeams: [],
            itTasks: {}
          };
          requests.push(newRequest);
          console.log('Account Request Data:', JSON.stringify(newRequest));
          sendEmail(
            accountApprovers[0].email,
            'New Account Request - Pending Your Approval',
            `New account request by ${newRequest.requesterName} submitted on ${newRequest.submissionDate}. Systems: ${selectedSystems.join(', ')}. Please review and approve.`
          );
          showAlert(`Account Request for ${newRequest.requesterName} submitted successfully!`, 'success');
          this.reset();
          systemFields.innerHTML = '';
          resetFormWarnings();
          renderApproval();
          renderRequests();
        };

        if (file && file.size > 0 && sapFile && sapFile.size > 0) {
          const reader1 = new FileReader();
          reader1.onload = function (e) {
            const reader2 = new FileReader();
            reader2.onload = function (f) {
              console.log('Files read successfully');
              submitRequest(e.target.result, f.target.result);
            };
            reader2.onerror = function (f) {
              console.error('SAP file reading failed:', f);
              showAlert('Failed to read uploaded SAP file.', 'error');
            };
            reader2.readAsDataURL(sapFile);
          };
          reader1.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader1.readAsDataURL(file);
        } else if (file && file.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('File read successfully');
            submitRequest(e.target.result, null);
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else if (sapFile && sapFile.size > 0) {
          const reader = new FileReader();
          reader.onload = function (e) {
            console.log('SAP file read successfully');
            submitRequest(null, e.target.result);
          };
          reader.onerror = function (e) {
            console.error('SAP file reading failed:', e);
            showAlert('Failed to read uploaded SAP file.', 'error');
          };
          reader.readAsDataURL(sapFile);
        } else {
          submitRequest(null, null);
        }
      });

      // Navigation between sections
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-section');
          sections.forEach(s => s.classList.remove('active'));
          const targetSection = document.getElementById(target);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (target === 'approval') renderApproval();
          if (target === 'history') renderHistory();
          if (target === 'requests') renderRequests();
          if (target === 'it-manager') renderITManager();
          if (target === 'task-dashboard') renderTaskDashboard();
        });
      });

      // Approval Workflow
      window.approveRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (!req) {
          console.log(`Request ${id} not found`);
          showAlert(`Request ${id} not found.`, 'error');
          return;
        }
        
        const approvers = type === 'personnel' ? personnelApprovers : accountApprovers;
        const currentApproverIndex = approvers.findIndex(a => req.status.trim() === `Awaiting ${a.role}`);
        console.log(`Approving ${id}, Status: ${req.status}, Index: ${currentApproverIndex}`);

        if (currentApproverIndex === -1) {
          showAlert('Invalid approval stage for request ' + id, 'error');
          return;
        }

        const approverRole = approvers[currentApproverIndex].role;
        if (!req.approvalDates) req.approvalDates = {};
        req.approvalDates[approverRole] = new Date().toLocaleDateString();

        if (currentApproverIndex < approvers.length - 1) {
          req.status = `Awaiting ${approvers[currentApproverIndex + 1].role}`;
          showAlert(`Request ${id} approved by ${approverRole}.`, 'success');
          sendEmail(
            approvers[currentApproverIndex + 1].email,
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request - Pending Your Approval`,
            `A ${type} request ${id} is pending your approval. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}, Submitted: ${req.submissionDate}. Please review.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        } else {
          req.status = 'Pending IT Manager';
          showAlert(`Request ${id} fully approved! Now pending IT Manager assignment.`, 'success');
          sendEmail(
            'it.manager@cfao.com',
            'New Request Ready for IT Assignment',
            `A ${type} request ${id} has been fully approved and is ready for IT team assignment. Employee: ${type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Please assign to appropriate IT teams.`
          ).catch(() => console.log(`Email failed for ${id}, proceeding without notification`));
        }
        renderApproval();
        renderHistory();
        renderITManager();
        renderRequests();
      };

      window.rejectRequest = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Rejected';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `${type.charAt(0).toUpperCase() + type.slice(1)} Request Rejected`,
            `${type} request ${id} has been rejected.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} rejected.`, 'error');
        }
        renderApproval();
        renderHistory();
        renderRequests();
      };

      window.uploadSignedFile = function (id) {
        const fileInput = document.getElementById(`signedFile_${id}`);
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const req = requests.find(r => r.id === id);
            if (req) {
              req.signedFile = e.target.result;
              console.log(`Signed file uploaded for request ${id}:`, req.signedFile);
              showAlert(`Signed file uploaded for request ${id}.`, 'success');
              renderApproval();
              renderHistory();
            }
          };
          reader.onerror = function (e) {
            console.error('File reading failed:', e);
            showAlert('Failed to read uploaded file.', 'error');
          };
          reader.readAsDataURL(file);
        } else {
          showAlert('Please select a file to upload.', 'error');
        }
      };

      window.markInProgress = function (id) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'In Progress';
          showAlert(`Request ${id} marked as In Progress.`, 'success');
        }
        renderHistory();
        renderRequests();
      };

      window.markComplete = function (id, type) {
        const req = requests.find(r => r.id === id);
        if (req) {
          req.status = 'Completed';
          sendEmail(
            type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
            `Request Completed`,
            `Request ${id} has been completed.`
          ).catch(() => console.log('Email failed, proceeding without notification'));
          showAlert(`Request ${id} completed.`, 'success');
        }
        renderHistory();
        renderRequests();
      };
      window.assignToITTeams = function (requestId) {
        const req = requests.find(r => r.id === requestId);
        if (!req) {
          showAlert('Request not found.', 'error');
          return;
        }

        const checkboxes = document.querySelectorAll(`input[name="assign_${requestId}"]:checked`);
        const selectedTeams = Array.from(checkboxes).map(cb => cb.value);

        if (selectedTeams.length === 0) {
          showAlert('Please select at least one IT team.', 'error');
          return;
        }

        req.assignedTeams = selectedTeams;
        req.status = 'In Progress';
        if (!req.itTasks) req.itTasks = {};

        selectedTeams.forEach(team => {
          if (!req.itTasks[team]) {
            req.itTasks[team] = { status: 'Not Started', notes: '' };
          }
        });

        selectedTeams.forEach(team => {
          const teamInfo = itTeams[team];
          if (teamInfo) {
            sendEmail(
              teamInfo.email,
              'New IT Task Assigned',
              `A new IT task has been assigned to ${team}. Request ID: ${requestId}, Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}. Please review and update status.`
            ).catch(() => console.log(`Email failed for ${team}, proceeding without notification`));
          }
        });

        showAlert(`Request ${requestId} assigned to ${selectedTeams.length} IT team(s).`, 'success');
        renderITManager();
        renderHistory();
        renderTaskDashboard();
        renderRequests();
      };

      window.updateTaskStatus = function (requestId, teamName) {
        const req = requests.find(r => r.id === requestId);
        if (!req || !req.itTasks) return;

        const statusSelect = document.getElementById(`taskStatus_${requestId}_${teamName}`);
        if (statusSelect) {
          req.itTasks[teamName].status = statusSelect.value;
          
          const allCompleted = req.assignedTeams.every(team => 
            req.itTasks[team] && req.itTasks[team].status === 'Completed'
          );

          if (allCompleted && req.status !== 'Completed') {
            req.status = 'Completed';
            sendEmail(
              req.type === 'personnel' ? 'hr@cfao.com' : 'hr.ict@cfao.com',
              'All IT Tasks Completed',
              `All IT tasks for request ${requestId} have been completed. Employee: ${req.type === 'personnel' ? req.employeeName : `${req.firstName} ${req.lastName}`}.`
            ).catch(() => console.log('Email failed, proceeding without notification'));
          }

          renderTaskDashboard();
          renderHistory();
          renderRequests();
        }
      };

      window.saveTaskNotes = function (requestId, teamName) {
        const req = requests.find(r => r.id === requestId);
        if (!req || !req.itTasks) return;

        const notesTextarea = document.getElementById(`taskNotes_${requestId}_${teamName}`);
        if (notesTextarea) {
          req.itTasks[teamName].notes = notesTextarea.value;
          showAlert('Task notes saved.', 'success');
        }
      };

      // PDF GENERATION FUNCTIONS - Due to length, I'll provide the complete PDF generation code in a separate final block
      // This includes downloadHR7PDF, downloadCorp6PDF, and downloadCorp5PDF functions
    });

    // Login and Role Management
    function handleLogin() {
      const role = document.getElementById('loginRole').value;
      if (!role) {
        showAlert('Please select a role to login.', 'error');
        return;
      }
      
      currentUserRole = role;
      document.getElementById('userRoleBadge').textContent = role;
      
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      
      updateNavigationForRole(role);
      
      showAlert(`Welcome, ${role}!`, 'success');
    }

    function handleLogout() {
      currentUserRole = '';
      document.getElementById('loginRole').value = '';
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      showAlert('Logged out successfully.', 'success');
    }

    function updateNavigationForRole(role) {
      const navButtons = document.querySelectorAll('.nav-button');
      navButtons.forEach(button => {
        const allowedRoles = button.getAttribute('data-role').split(',');
        if (allowedRoles.includes(role)) {
          button.style.display = 'inline-block';
        } else {
          button.style.display = 'none';
        }
      });
      
      const firstVisible = document.querySelector('.nav-button[style="display: inline-block;"]');
      if (firstVisible) {
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        firstVisible.classList.add('active');
        const targetSection = firstVisible.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(targetSection).classList.add('active');
      }
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1f2937;
      min-height: 100vh;
    }

    .hidden {
      display: none !important;
    }

    .login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .login-container {
      width: 100%;
      max-width: 450px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h1 {
      color: #667eea;
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
      font-weight: 700;
    }

    .login-header p {
      color: #6b7280;
      margin: 0;
      font-size: 0.95rem;
    }

    .login-form {
      margin-top: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #374151;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-select {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
      color: #1f2937;
    }

    .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-button {
      width: 100%;
      padding: 0.875rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .login-button:active {
      transform: translateY(0);
    }

    .dashboard-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-header h1 {
      margin: 0;
      color: #667eea;
      font-size: 1.75rem;
      font-weight: 700;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-role-badge {
      padding: 0.5rem 1.25rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .logout-button {
      padding: 0.5rem 1.25rem;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .dashboard-container {
      min-height: 100vh;
      background: #f9fafb;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem 2rem 2rem;
    }

    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      flex-wrap: wrap;
    }

    .nav-button {
      padding: 0.75rem 1.5rem;
      background: #f3f4f6;
      border: 2px solid transparent;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #6b7280;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .nav-button:hover {
      background: #e5e7eb;
      color: #374151;
      transform: translateY(-2px);
    }

    .nav-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .section {
      display: none;
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.3s ease-in;
    }

    form {
      max-width: 100%;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section.active {
      display: block;
    }

    .section h2 {
      color: #1f2937;
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      border-bottom: 3px solid #667eea;
      padding-bottom: 0.5rem;
    }

    .section h3 {
      color: #374151;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .section-subtitle {
      color: #374151;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .form-group-compact {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .radio-group {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: normal;
      cursor: pointer;
    }

    .radio-label input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .checkbox-group-compact {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: normal;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    input, select, textarea {
      padding: 0.625rem 0.875rem;
      margin: 0.25rem 0;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      width: 100%;
      box-sizing: border-box;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }

    input[readonly] {
      background-color: #f3f4f6;
      cursor: not-allowed;
      color: #6b7280;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    input[type="file"] {
      padding: 0.5rem;
    }

    .system-field {
      margin: 1rem 0;
      padding: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .system-field:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    fieldset {
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .flex {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
      margin-bottom: 0.75rem;
    }

    .field-row label {
      min-width: 140px;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .flex {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .flex .field-row {
      flex: 1;
      min-width: 250px;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      margin: 0.5rem 0;
      align-items: center;
    }

    .checkbox-grid label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.5rem;
    }

    .checkbox-grid input[type="checkbox"] {
      margin: 0;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 0.5rem 0;
    }

    input[type="submit"], button[type="submit"] {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 0.875rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    input[type="submit"]:hover, button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    button {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-size: 0.9rem;
    }

    button:not(.nav-button):not(.login-button):not(.logout-button):not(.download-btn):not(.download-btn-small) {
      background: #667eea;
      color: white;
    }

    button:not(.nav-button):not(.login-button):not(.logout-button):not(.download-btn):not(.download-btn-small):hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    th {
      text-align: left;
      padding: 1rem;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      text-align: left;
      padding: 1rem;
      border-bottom: 1px solid #f3f4f6;
      color: #374151;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    a {
      color: #3b82f6;
      text-decoration: underline;
    }

    #alert {
      z-index: 1000;
      max-width: 300px;
    }

    .lead-time-warning {
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .lead-time-warning.warning-red {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .lead-time-status {
      padding: 0.5rem 0.75rem;
      margin: 0.5rem 0;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-block;
    }

    .status-green {
      color: #059669;
      background-color: #d1fae5;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: inline-block;
    }

    .status-red {
      color: #dc2626;
      background-color: #fee2e2;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: inline-block;
    }

    .filter-section {
      margin: 1rem 0;
      padding: 1.25rem;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      border: 1px solid #d1d5db;
    }

    .filter-section label {
      margin-right: 0.5rem;
      font-weight: 600;
    }

    .team-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border-radius: 0.5rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .it-manager-requests {
      display: grid;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .it-request-card {
      padding: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .it-request-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .it-request-card h3 {
      margin-top: 0;
      color: #1f2937;
    }

    .team-assignment {
      margin: 1rem 0;
      padding: 1.25rem;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .team-assignment label {
      display: block;
      margin: 0.5rem 0;
      font-weight: normal;
    }

    .team-assignment input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
    }

    .task-list {
      display: grid;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .task-card {
      padding: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .task-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .task-card h4 {
      margin-top: 0;
      color: #1f2937;
    }

    .task-actions {
      margin-top: 1rem;
      padding: 1.25rem;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .task-actions select,
    .task-actions textarea {
      width: 100%;
      margin: 0.5rem 0;
    }

    .task-actions button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
    }

    .team-filter {
      margin: 1rem 0;
      padding: 1.25rem;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      border: 1px solid #d1d5db;
    }

    .download-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-size: 0.9rem;
      margin: 0.25rem;
      display: inline-block;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .download-btn-small {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-size: 0.8rem;
      margin: 0.25rem;
      display: inline-block;
    }

    .download-btn-small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .type-badge {
      display: inline-block;
      padding: 0.375rem 0.875rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-personnel {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .type-account {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
    }

    .status-badge {
      display: inline-block;
      padding: 0.375rem 0.875rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .status-awaiting-section-manager,
    .status-awaiting-department-gm,
    .status-awaiting-hr-manager,
    .status-awaiting-gm-hr,
    .status-awaiting-dmd,
    .status-awaiting-md {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pending-it-manager,
    .status-pending {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-in-progress {
      background: #e0e7ff;
      color: #4338ca;
    }

    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    @media (max-width: 768px) {
      .login-card {
        padding: 2rem 1.5rem;
      }

      .dashboard-header {
        padding: 1rem;
      }

      .header-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .nav-button {
        width: 100%;
        text-align: center;
      }

      .container {
        padding: 0 1rem 1rem 1rem;
      }

      .section {
        padding: 1.5rem;
      }

      .flex {
        flex-direction: column;
        gap: 1rem;
      }

      .field-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .field-row label {
        min-width: auto;
        width: 100%;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
      }

      .checkbox-group {
        flex-direction: column;
      }

      #alert {
        max-width: 100%;
        top: 0;
        right: 0;
        left: 0;
        border-radius: 0;
      }

      .it-request-card,
      .task-card {
        padding: 1rem;
      }

      table {
        font-size: 0.85rem;
      }

      th, td {
        padding: 0.75rem 0.5rem;
      }
    }
  </style>
</body>
</html>